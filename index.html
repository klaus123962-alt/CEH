 <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¶–ï–•</title>
    <style>
        /* –°—Ç–∏–ª–∏ –∏–∑ —Ñ–æ—Ä–º—ã –û–ø–µ—Ä */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: #e6f2ff; padding: 10px; line-height: 1.4; }
        .header-container { text-align: center; margin-bottom: 20px; padding: 15px; background: #001355; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .header-container img { max-width: 350px; width: 100%; height: auto; margin: 10px 0; }
        h2 { text-align: center; font-size: 20px; margin: 15px 0 20px 0; color:white; font-weight: 700; }
        #viewForm { background: white; padding: 15px; border-radius: 12px; margin: 0 auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .form-group { margin-bottom: 12px; }
        label { font-weight: 600; display: block; margin-bottom: 6px; font-size: 14px; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; background: #fafafa; transition: all 0.3s ease; }
        select:focus, input:focus, textarea:focus { outline: none; border-color: #4285f4; background: white; box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.15); }
        input[readonly], textarea[readonly] { background: #f5f5f5; color: #666; border-color: #ddd; cursor: not-allowed; }
        input[readonly]:focus, textarea[readonly]:focus { border-color: #ddd; background: #f5f5f5; box-shadow: none; }
        .section-title { font-size: 18px; font-weight: bold; margin: 20px 0 10px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .section-title-with-button { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 20px 0 10px 0; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 5px;
        }
        .section-title-with-button span { 
            font-size: 18px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        #message { margin-top: 15px; padding: 14px; border-radius: 8px; font-size: 16px; text-align: center; }
        .success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .loading { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .validation-error { border-color: #dc3545 !important; background-color: #fff5f5 !important; }
        .validation-success { border-color: #28a745 !important; }
        .error-message { color: #dc3545; font-size: 14px; margin-top: 5px; display: none; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23555'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; }
        button { width: 100%; padding: 16px; background: #4285f4; color: white; border: none; border-radius: 10px; font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
        button:hover { background: #3367d6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }
        button:active { transform: translateY(0); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .image-container { display: flex; gap: 10px; align-items: center; }
        .image-field { flex: 0.8; }
        .image-preview { flex: 1; max-width: 150px; max-height: 60px; border: 1px solid #ddd; border-radius: 5px; display: none; object-fit: contain; background: #f9f9f9; padding: 5px; }
        
        .markirovka-not-checked { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24 !important; }
        .markirovka-checked { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724 !important; }
        
        .downtime-row, .waste-row {
          position: relative;
          margin-bottom: 12px;
          padding: 10px;
          border: 1px solid #e9ecef;
          border-radius: 10px;
          background: #f8f9fa;
        }
        
        .downtime-container, .waste-container {
          display: flex;
          gap: 10px;
          margin-bottom: 8px;
        }
        
        .downtime-container > div, .waste-container > div {
          flex: 1;
        }
        
        .downtime-container label, .waste-container label {
          font-weight: 600;
          font-size: 13px;
          color: #7f8c8d;
          text-transform: uppercase;
        }
        
        .add-downtime-btn, .add-waste-btn {
          background: #f8f9fa;
          color: #6c757d;
          border: 2px dashed #dee2e6;
          padding: 10px;
          border-radius: 10px;
          width: 50px;
          height: 50px;
          font-size: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          margin: 10px auto;
          transition: all 0.3s ease;
        }
        
        .add-downtime-btn:hover, .add-waste-btn:hover {
          background: #e9ecef;
          border-color: #4285f4;
          color: #4285f4;
        }
        
        .remove-downtime-btn, .remove-waste-btn {
          position: absolute;
          top: -10px;
          right: -10px;
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          font-size: 14px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          padding: 0;
        }
        
        .no-downtime-checkbox {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
          padding: 10px;
          background: #f8f9fa;
          border-radius: 8px;
        }
        
        .no-downtime-checkbox input[type="checkbox"] {
          width: 20px;
          height: 20px;
        }
        
        .no-downtime-checkbox label {
          font-weight: 600;
          color: #2c3e50;
          margin: 0;
          text-transform: none;
        }
        
        .disabled-section {
          opacity: 0.6;
          pointer-events: none;
        }
        
        .time-input-container {
          display: flex;
          gap: 10px;
          align-items: center;
        }
        
        .time-input-wrapper {
          flex: 1;
        }
        
        .time-separator {
          font-weight: bold;
          font-size: 18px;
          color: #2c3e50;
        }
        
        .waste-row-container {
          display: flex;
          align-items: flex-end;
          gap: 10px;
          margin-bottom: 12px;
        }
        
        .waste-select-wrapper {
          flex: 1;
        }
        
        .waste-select-wrapper select {
          padding: 10px;
          font-size: 14px;
        }
        
        .add-waste-btn-inline {
          background: #f8f9fa;
          color: #6c757d;
          border: 2px dashed #dee2e6;
          border-radius: 10px;
          width: 40px;
          height: 40px;
          font-size: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.3s ease;
          flex-shrink: 0;
          margin-top: 20px;
        }
        
        .add-waste-btn-inline:hover {
          background: #e9ecef;
          border-color: #4285f4;
          color: #4285f4;
        }
        
        .remove-waste-btn-inline {
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          font-size: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          padding: 0;
          flex-shrink: 0;
          margin-top: 20px;
        }
        
        .obrazcy-container {
          display: flex;
          gap: 10px;
        }
        
        .obrazcy-container > div {
          flex: 1;
        }
        
        .waste-types-container {
          display: flex;
          gap: 8px;
          margin-bottom: 12px;
          align-items: flex-end;
        }
        
        .waste-types-container > div {
          flex: 1;
          min-width: 0;
        }
        
        .waste-types-container .add-waste-btn-inline {
          flex: 0 0 40px;
        }
        
        .waste-types-container select,
        .waste-types-container input {
          padding: 10px;
          font-size: 13px;
        }
        
        .waste-types-container label {
          font-size: 12px;
          margin-bottom: 4px;
        }
        
        .harakteristiki-input {
          resize: none;
          min-height: 60px;
        }
        
        .obrazcy-input-container {
          display: flex;
          gap: 10px;
          align-items: center;
        }
        
        .obrazcy-input-wrapper {
          flex: 1;
        }
        
        .obrazcy-separator {
          font-weight: bold;
          font-size: 18px;
          color: #2c3e50;
        }
        
        .obrazcy-waste-container {
          display: flex;
          gap: 10px;
        }
        
        .obrazcy-waste-container > div {
          flex: 1;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –í–ò–ö */
        .open-vik-btn {
            width: auto !important;
            padding: 10px 20px !important;
            background-color: #001355 !important;
            font-size: 14px !important;
            margin-top: 0 !important;
            flex-shrink: 0;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–æ—Ä–º—ã –í–ò–ö */
        .vik-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0, 0, 0, 0.7);
          display: none;
          justify-content: center;
          align-items: flex-start;
          z-index: 10000;
          overflow-y: auto;
          padding: 20px;
        }
        
        .vik-modal-container {
          background-color: white;
          border-radius: 10px;
          width: 95%;
          max-width: 1200px;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
          margin: 20px auto;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
          animation: modalFadeIn 0.3s ease-out;
        }
        
        .vik-modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 20px;
          background-color: #001355;
          color: white;
          border-radius: 10px 10px 0 0;
        }
        
        .vik-modal-title {
          font-size: 18px;
          font-weight: bold;
        }
        
        .vik-modal-close {
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: background-color 0.3s;
        }
        
        .vik-modal-close:hover {
          background-color: rgba(255, 255, 255, 0.2);
        }
        
        .vik-modal-content {
          padding: 20px;
        }
        
        @keyframes modalFadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) { 
          body { padding: 8px; font-size: 18px; } 
          #viewForm { padding: 12px; border-radius: 10px; } 
          .header-container { margin-bottom: 15px; padding: 12px; } 
          .header-container img { max-width: 280px; } 
          h2 { font-size: 18px; margin-bottom: 15px; } 
          label { font-size: 14px; margin-bottom: 5px; } 
          select, input, textarea { padding: 14px; font-size: 16px; min-height: 50px; border-width: 2px; } 
          textarea { min-height: 100px; font-size: 17px; } 
          .image-container { flex-direction: column; }
          .image-preview { max-width: 100%; max-height: 80px; }
          .downtime-container, .waste-container { flex-direction: column; gap: 8px; }
          .downtime-container > div, .waste-container > div { width: 100%; }
          .time-input-container { flex-direction: column; }
          .time-separator { display: none; }
          .waste-row-container { flex-direction: column; align-items: stretch; }
          .add-waste-btn-inline { align-self: center; margin-top: 5px; }
          .obrazcy-container { flex-direction: column; }
          .waste-types-container { flex-direction: column; gap: 12px; }
          .waste-types-container .add-waste-btn-inline,
          .waste-types-container .remove-waste-btn-inline { 
            width: 50px; 
            height: 50px; 
            align-self: center;
            margin-top: 10px;
          }
          .obrazcy-input-container { flex-direction: column; }
          .obrazcy-separator { display: none; }
          .obrazcy-waste-container { flex-direction: column; }
          .vik-modal-container {
            width: 100%;
            margin: 10px;
            max-height: 95vh;
          }
          .section-title-with-button {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
          }
          .open-vik-btn {
            align-self: stretch;
          }
        }
        @media (max-width: 480px) { 
          .header-container img { max-width: 250px; } 
          select, input, textarea { padding: 12px; font-size: 16px; } 
        }
    </style>
    
    <!-- –°—Ç–∏–ª–∏ –∏–∑ —Ñ–æ—Ä–º—ã –í–ò–ö (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞) -->
    <style id="vik-styles">
        .vik-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            background-color: white;
            border-radius: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        
        .vik-container * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        .vik-container .header-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .vik-container .form-group {
            margin-bottom: 15px;
        }
        
        .vik-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .vik-container input, 
        .vik-container select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
        }
        
        .vik-container input:focus, 
        .vik-container select:focus {
            outline: none;
            border-color: #001355;
        }
        
        .vik-container input[type="checkbox"] {
            width: auto;
            transform: scale(1.3);
        }
        
        .vik-container .readonly {
            background-color: #f9f9f9;
            color: #666;
            border-color: #eee;
        }
        
        .vik-container .input-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .vik-container .layer-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .vik-container .layer-control {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .vik-container .nomenclature-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .vik-container .nomenclature-section h3 {
            margin-bottom: 15px;
            color: #001355;
            border-bottom: 2px solid #001355;
            padding-bottom: 8px;
            font-size: 16px;
        }
        
        .vik-container .norms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .vik-container .norm-item {
            display: flex;
            flex-direction: column;
        }
        
        .vik-container .norm-item label {
            font-weight: normal;
            font-size: 13px;
            color: #666;
        }
        
        .vik-container .norm-value {
            font-weight: bold;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            min-height: 40px;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        .vik-container table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .vik-container th, 
        .vik-container td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }
        
        .vik-container th {
            background-color: #f2f2f2;
            font-weight: bold;
            font-size: 14px;
        }
        
        .vik-container .measurements-table th, 
        .vik-container .measurements-table td {
            text-align: center;
            min-width: 120px;
        }
        
        .vik-container .measurement-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        
        .vik-container .measurement-input:focus {
            outline: none;
            border-color: #001355;
        }
        
        .vik-container .disabled-field {
            background-color: #f0f0f0 !important;
            color: #999 !important;
            cursor: not-allowed !important;
        }
        
        .vik-container .locked-field {
            background-color: #f9f9f9 !important;
            color: #333 !important;
            cursor: default !important;
            border-color: #ccc !important;
        }
        
        .vik-container .time-slot-header {
            background-color: #001355;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 8px;
        }
        
        .vik-container .btn {
            padding: 14px;
            background-color: #001355;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            display: block;
            width: 100%;
            margin-top: 10px;
        }
        
        .vik-container .btn:hover:not(:disabled) {
            background-color: #002288;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .vik-container .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .vik-container .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .vik-container .btn-submit {
            background-color: #27ae60;
        }
        
        .vik-container .btn-submit:hover:not(:disabled) {
            background-color: #219653;
        }
        
        .vik-container .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            border-left: 4px solid #28a745;
        }
        
        .vik-container .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            border-left: 4px solid #dc3545;
        }
        
        .vik-container .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            border-left: 4px solid #17a2b8;
        }
        
        .vik-container .date-select-group {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #001355;
        }
        
        .vik-container .date-select-group h3 {
            margin-bottom: 15px;
            color: #001355;
            font-size: 16px;
        }
        
        .vik-container .error-field {
            border-color: #dc3545 !important;
            background-color: #f8d7da !important;
        }
        
        .vik-container .section-title {
            background-color: #001355;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: 20px 0 15px 0;
            font-size: 16px;
            text-align: center;
        }
        
        .vik-container .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .vik-container .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .vik-container .table-responsive table {
            margin-bottom: 0;
            min-width: 800px;
        }
        
        .vik-container input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        .vik-container input[type="number"]::-webkit-inner-spin-button,
        .vik-container input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .vik-container .required::after {
            content: " *";
            color: #dc3545;
        }
        
        @media (min-width: 768px) {
            .vik-container .header-info {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .vik-container .input-group {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .vik-container .layer-controls {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .vik-container .layer-control {
                flex-direction: column;
                text-align: center;
                gap: 10px;
                padding: 15px;
            }
            
            .vik-container .measurements-table {
                font-size: 13px;
            }
            
            .vik-container .measurements-table th,
            .vik-container .measurements-table td {
                min-width: 100px;
            }
            
            .vik-container .norms-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .vik-container .header-info {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .vik-container .input-group {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .vik-container .measurements-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã -->
    <div class="header-container">
        <img src="http://irtz.ru/PC/pc.png" alt="–õ–æ–≥–æ—Ç–∏–ø">
        <h2 id="mainTitle">–§–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¶–ï–•–∞</h2>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ -->
    <form id="viewForm" autocomplete="off">
        <div class="form-group">
            <label for="dateSelect">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</label>
            <input type="date" id="dateSelect" required>
        </div>

        <div class="form-group" id="employeeGroup" style="display: none;">
            <label for="employeeSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
            <select id="employeeSelect" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
            </select>
        </div>

        <div id="employeeData" style="display: none;">
            <div class="section-title">–î–∞–Ω–Ω—ã–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</div>
            <div class="form-group"><label>–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞</label><input type="text" id="fioView" readonly></div>
            <div class="form-group"><label>–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2</label><input type="text" id="fio2View" readonly></div>
            <div class="form-group"><label>–°–º–µ–Ω–∞</label><input type="text" id="smenaView" readonly></div>
            <div class="form-group"><label>–î–µ–Ω—å/–ù–æ—á—å</label><input type="text" id="denbView" readonly></div>
            <div class="form-group"><label>–í–∏–¥ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label><input type="text" id="proizView" readonly></div>
            <div class="form-group"><label>–†–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä</label><input type="text" id="centerView" readonly></div>
            <div class="form-group"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</label><textarea id="commentView" readonly></textarea></div>
            <div class="form-group"><label>–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</label><input type="text" id="nomenklaturaView" readonly></div>
            <div class="form-group"><label>–ü–∞—Ä—Ç–∏—è</label><input type="text" id="partiyaView" readonly></div>
            <div class="form-group"><label>–í–µ—Å –ø–æ–≥. –º–µ—Ç—Ä–∞ (–∫–≥)</label><input type="text" id="vesPogMetraView" readonly></div>
            <div class="form-group"><label>–û—Å—Ç–∞—Ç–æ–∫ –ø–æ –ø–ª–∞–Ω—É</label><input type="text" id="ostatokView" readonly></div>
            
            <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
            <div class="form-group">
                <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</label>
                <textarea id="harakteristikiView" class="harakteristiki-input" readonly></textarea>
            </div>
            
            <div class="form-group"><label>–ú–∞—Ä–∫–∞ –ü–≠ –≤ –ì–ü</label><input type="text" id="markaPEView" readonly></div>
            <div class="form-group"><label>–¢–µ—Ö–Ω. –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label><input type="text" id="proizvoditelnostView" readonly></div>
            <div class="form-group"><label>–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä—É–±—ã</label><input type="text" id="markirovkaView" readonly></div>
            
            <!-- –ü–æ–ª–µ "–ó–Ω–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" -->
            <div class="form-group">
                <label>–ó–Ω–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <div class="image-container">
                    <input type="text" id="znakImageView" class="image-field" readonly>
                    <img id="znakImagePreview" class="image-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                </div>
            </div>
            
            <!-- –û–±—Ä–∞–∑—Ü—ã –≤ –æ–¥–∏–Ω —Ä—è–¥ -->
            <div class="form-group">
                <div class="obrazcy-container">
                    <div>
                        <label>–û–±—Ä–∞–∑—Ü—ã —à—Ç.</label>
                        <input type="text" id="obrazcyShtView" readonly>
                    </div>
                    <div>
                        <label>–û–±—Ä–∞–∑—Ü—ã –º–µ—Ç—Ä.</label>
                        <input type="text" id="obrazcyMetrView" readonly>
                    </div>
                </div>
            </div>
            
            <div class="form-group"><label>–ú–∞—Ä–∫–∞ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞</label><input type="text" id="markaRegranulataView" readonly></div>
            <div class="form-group"><label>–ö–æ–ª-–≤–æ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞ %</label><input type="text" id="kolvoRegranulataView" readonly></div>
            <div class="form-group"><label>–ù–æ—Ä–º–∞ –≤—Ä. –Ω–∞ –ø–µ—Ä–µ–Ω–∞–ª–∞–¥–∫—É</label><input type="text" id="normaVremeniView" readonly></div>
        </div>

        <div id="employeeInput" style="display: none;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –í–ò–ö –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
            <div class="section-title-with-button">
                <span>–î–∞–Ω–Ω—ã–µ –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</span>
                <button type="button" class="btn open-vik-btn" id="openVikBtn">üìã –ß–µ–∫-–ª–∏—Å—Ç –í–ò–ö</button>
            </div>
            
            <div class="form-group">
                <label for="proizvoditelnostFact">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç</label>
                <input type="number" id="proizvoditelnostFact" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å" required>
                <div class="error-message" id="proizvoditelnostFactError">–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                <div class="error-message" id="productivityDeviationError" style="display: none;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>
            </div>
            
            <div class="form-group">
                <label for="proverkaMarkirovki">–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</label>
                <select id="proverkaMarkirovki" required class="markirovka-not-checked">
                    <option value="–ù–ï –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ">–ù–ï –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ</option>
                    <option value="–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ">–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ</option>
                </select>
                <div class="error-message" id="proverkaMarkirovkiError">–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label for="nomerOtrezka">–ù–æ–º–µ—Ä –æ—Ç—Ä–µ–∑–∫–∞/–±—É—Ö—Ç—ã</label>
                <input type="text" id="nomerOtrezka" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç—Ä–µ–∑–∫–∞/–±—É—Ö—Ç—ã" required>
                <div class="error-message" id="nomerOtrezkaError">–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label for="kolichestvoGP">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω–æ–π –ì–ü</label>
                <input type="text" id="kolichestvoGP" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ì–ü" required>
                <div class="error-message" id="kolichestvoGPError">–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label for="vesGP">–í–µ—Å –ì–ü</label>
                <input type="number" id="vesGP" step="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –ì–ü" required>
                <div class="error-message" id="vesGPError">–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label for="vvodRegranulata">–í–≤–æ–¥ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞ –ö–ì.</label>
                <input type="number" id="vvodRegranulata" step="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞" required>
                <div class="error-message" id="vvodRegranulataError">–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <!-- –û–±—Ä–∞–∑—Ü—ã -->
            <div class="form-group">
                <label>–û–±—Ä–∞–∑—Ü—ã</label>
                <div class="obrazcy-input-container">
                    <div class="obrazcy-input-wrapper">
                        <input type="number" id="obrazcyKolichestvo" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="0" required>
                    </div>
                    <div class="obrazcy-separator">x</div>
                    <div class="obrazcy-input-wrapper">
                        <input type="number" id="obrazcyMetrazh" step="0.01" placeholder="–ú–µ—Ç—Ä–∞–∂" min="0" required>
                    </div>
                </div>
                <div class="error-message" id="obrazcyError">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è –æ–±—Ä–∞–∑—Ü–æ–≤</div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–æ–≤, –ø—Ä–∏—á–∏–Ω –∏ –≤–µ—Å–∞ –æ—Ç—Ö–æ–¥–æ–≤ -->
            <div class="form-group">
                <label>–û—Ç—Ö–æ–¥—ã</label>
                <div id="waste-container">
                    <!-- –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –≤–∏–¥–æ–≤, –ø—Ä–∏—á–∏–Ω –∏ –≤–µ—Å–∞ –æ—Ç—Ö–æ–¥–æ–≤ -->
                    <div class="waste-types-container">
                        <div>
                            <label>–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                            <select class="vidyOthodovSelect" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ --</option>
                                <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ</option>
                                <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                                <option value="–ê–≤–∞—Ä–∏–π–Ω—ã–µ">–ê–≤–∞—Ä–∏–π–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div>
                            <label>–ü—Ä–∏—á–∏–Ω—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                            <select class="prichinaOthodovSelect" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                            </select>
                        </div>
                        <div>
                            <label>–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤ (–∫–≥)</label>
                            <input type="number" class="vesOthodovInline" step="0.01" placeholder="–í–µ—Å" min="0" required>
                        </div>
                        <div class="add-waste-btn-inline" id="add-waste-btn-inline">+</div>
                    </div>
                </div>
                <div class="error-message" id="wasteError">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –æ—Ç—Ö–æ–¥–æ–≤</div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ—Å—Ç–æ—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div class="form-group">
                <label>–ü—Ä–∏—á–∏–Ω—ã –∏ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è</label>
                
                <!-- –ß–µ–∫–±–æ–∫—Å "–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è" -->
                <div class="no-downtime-checkbox">
                    <input type="checkbox" id="noDowntimeCheckbox">
                    <label for="noDowntimeCheckbox">–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è</label>
                </div>
                
                <div id="downtime-container">
                    <!-- –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –ø—Ä–æ—Å—Ç–æ—è -->
                    <div class="downtime-row">
                        <div class="downtime-container">
                            <div>
                                <label>–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è</label>
                                <select class="prichinaProstoya" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                                </select>
                            </div>
                            <div>
                                <label>–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è</label>
                                <div class="time-input-container">
                                    <div class="time-input-wrapper">
                                        <input type="number" class="downtime-hours" placeholder="–ß–∞—Å—ã" min="0" max="24" required>
                                    </div>
                                    <div class="time-separator">:</div>
                                    <div class="time-input-wrapper">
                                        <input type="number" class="downtime-minutes" placeholder="–ú–∏–Ω—É—Ç—ã" min="0" max="59" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="remove-downtime-btn">√ó</button>
                    </div>
                </div>
                <div class="add-downtime-btn" id="add-downtime-btn">+</div>
            </div>
            
            <button type="button" id="submitBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <div id="message"></div>
    </form>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ä–º—ã –í–ò–ö -->
    <div class="vik-modal-overlay" id="vikModal">
        <div class="vik-modal-container">
            <div class="vik-modal-header">
                <div class="vik-modal-title">–ß–ï–ö-–õ–ò–°–¢ –û–ü–ï–†–ê–¶–ò–û–ù–ù–û–ì–û –ö–û–ù–¢–†–û–õ–Ø<br>–í–∏–∑—É–∞–ª—å–Ω—ã–π –∏ –∏–∑–º–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å</div>
                <button class="vik-modal-close" id="closeVikModal">√ó</button>
            </div>
            <div class="vik-modal-content">
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ä–º—ã –í–ò–ö -->
                <div id="vikFormContainer" class="vik-container"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö (–∏–∑ –í–ò–ö) -->
    <div class="modal-overlay" id="deviationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 20000;">
        <div class="modal-content" style="background-color: white; border-radius: 10px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);">
            <div class="modal-title" style="color: #001355; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #001355; padding-bottom: 10px;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º</div>
            <div class="modal-message" style="margin-bottom: 20px; font-size: 15px; line-height: 1.5;">
                –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
            </div>
            
            <div class="deviation-list" id="deviationList" style="background-color: #f9f9f9; border-radius: 6px; padding: 15px; margin: 15px 0; max-height: 200px; overflow-y: auto;">
                <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="modal-message" style="margin-bottom: 20px; font-size: 15px; line-height: 1.5;">
                <strong>–í—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏?</strong><br>
                –ï—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–º—ã, –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è".<br>
                –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–º–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å".
            </div>
            
            <div class="modal-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-btn modal-btn-cancel" onclick="vikCancelSubmission()" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; background-color: #dc3545; color: white;">‚úó –û—Ç–º–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="modal-btn modal-btn-confirm" onclick="vikConfirmSubmission()" style="flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; background-color: #28a745; color: white;">‚úì –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <script>
        // –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–±–µ–∏—Ö —Ñ–æ—Ä–º
        class CombinedForm {
            constructor() {
                // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ —Ñ–æ—Ä–º—ã –û–ø–µ—Ä
                this.n8nWebhookUrl = 'https://tunnel.itrz.ru/webhook/get-data-ceh';
                this.saveWebhookUrl = 'https://tunnel.itrz.ru/webhook/save-production-ceh';
                this.downtimeUrl = 'https://tunnel.itrz.ru/webhook/get-downtime-ceh';
                this.wasteReasonsUrl = 'https://tunnel.itrz.ru/webhook/get-waste-reasons-ceh';
                this.spravkaUrl = 'https://tunnel.itrz.ru/webhook/get-spravka-data';
                
                // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ —Ñ–æ—Ä–º—ã –í–ò–ö
                this.N8N_WEBHOOK_URL = 'https://tunnel.itrz.ru/webhook/save-otk-check';
                this.TABLE_GP_WEBHOOK_URL = 'https://tunnel.itrz.ru/webhook/get-data-ceh';
                this.NORMS_WEBHOOK_URL = 'https://tunnel.itrz.ru/webhook/get-norms';
                this.PROGRESS_WEBHOOK_URL = 'https://tunnel.itrz.ru/webhook/check-otk-progress';
                
                this.allData = [];
                this.employees = [];
                this.currentEmployee = null;
                this.downtimeReasons = [];
                this.wasteReasons = [];
                
                // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º—ã –í–ò–ö
                this.vikAllData = [];
                this.vikEmployeeData = [];
                this.normsData = [];
                this.calculationFormulas = null;
                this.submittedSlots = new Set();
                this.slotData = {};
                this.pendingTimeSlot = null;
                this.pendingDeviations = [];
                this.pendingMeasurementData = null;
                this.vikCurrentEmployee = null;
                this.vikCurrentDate = null;
                
                // Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ (–∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
                this.images = {
                    // –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
                };
                
                this.init();
            }

            init() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –û–ø–µ—Ä
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dateSelect').value = today;
                this.vikCurrentDate = today;
                
                document.getElementById('dateSelect').addEventListener('change', e => {
                    this.loadDataByDate(e.target.value);
                    this.vikCurrentDate = e.target.value;
                });
                
                document.getElementById('employeeSelect').addEventListener('change', e => this.displayEmployeeData(e.target.value));
                
                this.addValidationHandlers();
                this.loadSpravkaData();
                this.loadDataByDate(today);

                document.getElementById('submitBtn').addEventListener('click', () => this.handleSubmit());
                
                document.getElementById('proverkaMarkirovki').addEventListener('change', (e) => {
                    this.handleMarkirovkaChange(e.target.value);
                });

                document.getElementById('add-downtime-btn').addEventListener('click', () => this.addDowntimeRow());
                document.getElementById('add-waste-btn-inline').addEventListener('click', () => this.addWasteRow());
                this.addTimeConversionHandlers();

                document.getElementById('noDowntimeCheckbox').addEventListener('change', (e) => {
                    this.handleNoDowntimeChange(e.target.checked);
                });

                this.addWasteTypeChangeHandlers();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–µ–π –≤–µ—Å–∞ –æ—Ç—Ö–æ–¥–æ–≤ –≤ —Å—Ç—Ä–æ–∫–∞—Ö
                document.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('vesOthodovInline')) {
                        this.validateInlineWasteField(e.target);
                    }
                });
                
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('vesOthodovInline')) {
                        this.clearInlineWasteError(e.target);
                    }
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –í–ò–ö
                this.setupVikModal();
                
                // –î–æ–±–∞–≤–ª–µ–Ω–æ: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                this.addProductivityValidation();
                this.addWasteValidationHandlers();
            }

            // ============= –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –í–ê–õ–ò–î–ê–¶–ò–ò =============

            /**
             * 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ñ–∞–∫—Ç vs —Ç–µ—Ö–Ω. –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
             */
            addProductivityValidation() {
                const productivityFactField = document.getElementById('proizvoditelnostFact');
                const productivityNormField = document.getElementById('proizvoditelnostView');
                
                if (!productivityFactField || !productivityNormField) return;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è
                productivityFactField.addEventListener('blur', () => this.checkProductivityDeviation());
                productivityFactField.addEventListener('input', () => {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
                    productivityFactField.classList.remove('validation-error');
                    const errorElement = document.getElementById('productivityDeviationError');
                    if (errorElement) errorElement.style.display = 'none';
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const originalDisplayEmployeeData = this.displayEmployeeData;
                this.displayEmployeeData = function(index) {
                    originalDisplayEmployeeData.call(this, index);
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                    setTimeout(() => this.checkProductivityDeviation(), 100);
                };
            }

            checkProductivityDeviation() {
                const factField = document.getElementById('proizvoditelnostFact');
                const normField = document.getElementById('proizvoditelnostView');
                
                if (!factField || !normField) return;
                
                const factValue = parseFloat(factField.value);
                const normValue = parseFloat(normField.value);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤—ã–µ
                if (isNaN(factValue) || isNaN(normValue) || normValue === 0) {
                    return;
                }
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
                const deviation = Math.abs((factValue - normValue) / normValue * 100);
                
                // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
                let errorElement = document.getElementById('productivityDeviationError');
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.id = 'productivityDeviationError';
                    errorElement.className = 'error-message';
                    errorElement.style.display = 'none';
                    errorElement.textContent = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ';
                    factField.parentNode.appendChild(errorElement);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –±–æ–ª–µ–µ 5%
                if (deviation > 5) {
                    factField.classList.add('validation-error');
                    errorElement.style.display = 'block';
                } else {
                    factField.classList.remove('validation-error');
                    errorElement.style.display = 'none';
                }
            }

            /**
             * 2-3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Å–∞ –æ—Ç—Ö–æ–¥–æ–≤ –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—Ç—Ö–æ–¥–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ
             */
            addWasteValidationHandlers() {
                // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö —Å—Ç—Ä–æ–∫
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('vidyOthodovSelect') || 
                        e.target.classList.contains('prichinaOthodovSelect')) {
                        this.updateWasteWeightLimit(e.target);
                    }
                });
                
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('vesOthodovInline')) {
                        this.validateWasteWeightAgainstLimit(e.target);
                    }
                });
            }

            updateWasteWeightLimit(selectElement) {
                const row = selectElement.closest('.waste-types-container');
                if (!row) return;
                
                const typeSelect = row.querySelector('.vidyOthodovSelect');
                const reasonSelect = row.querySelector('.prichinaOthodovSelect');
                const weightInput = row.querySelector('.vesOthodovInline');
                
                if (!typeSelect || !reasonSelect || !weightInput) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—Ç—Ö–æ–¥—ã + (–ó–∞–ø—É—Å–∫ –∏–ª–∏ –û—Å—Ç–∞–Ω–æ–≤–∫–∞)
                if (typeSelect.value === '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ' && 
                    (reasonSelect.value === '–ó–∞–ø—É—Å–∫' || reasonSelect.value === '–û—Å—Ç–∞–Ω–æ–≤–∫–∞')) {
                    
                    // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å –ø–æ–≥. –º–µ—Ç—Ä–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    const vesPogMetraField = document.getElementById('vesPogMetraView');
                    const vesPogMetra = parseFloat(vesPogMetraField ? vesPogMetraField.value : 0);
                    
                    if (!isNaN(vesPogMetra) && vesPogMetra > 0) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏—á–∏–Ω—ã
                        const multiplier = reasonSelect.value === '–ó–∞–ø—É—Å–∫' ? 25 : 6;
                        const maxWeight = vesPogMetra * multiplier;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–∏–º–∏—Ç –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
                        weightInput.dataset.maxWeight = maxWeight;
                        weightInput.title = `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å: ${maxWeight.toFixed(2)} –∫–≥`;
                        
                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        this.validateWasteWeightAgainstLimit(weightInput);
                    }
                } else {
                    // –£–¥–∞–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                    weightInput.removeAttribute('data-max-weight');
                    weightInput.removeAttribute('title');
                    weightInput.classList.remove('validation-error');
                    
                    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    const errorMsg = weightInput.parentNode.querySelector('.waste-weight-error');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            }

            validateWasteWeightAgainstLimit(weightInput) {
                const maxWeight = parseFloat(weightInput.dataset.maxWeight);
                
                if (!isNaN(maxWeight) && maxWeight > 0) {
                    const currentValue = parseFloat(weightInput.value);
                    
                    if (!isNaN(currentValue) && currentValue > maxWeight) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏
                        weightInput.classList.add('validation-error');
                        
                        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                        let errorMsg = weightInput.parentNode.querySelector('.waste-weight-error');
                        if (!errorMsg) {
                            errorMsg = document.createElement('div');
                            errorMsg.className = 'error-message waste-weight-error';
                            errorMsg.style.display = 'block';
                            weightInput.parentNode.appendChild(errorMsg);
                        }
                        
                        errorMsg.textContent = `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å: ${maxWeight.toFixed(2)} –∫–≥`;
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ –º–∞–∫—Å–∏–º—É–º–∞
                        weightInput.value = maxWeight.toFixed(2);
                    } else {
                        // –£–±–∏—Ä–∞–µ–º –æ—à–∏–±–∫—É
                        weightInput.classList.remove('validation-error');
                        
                        const errorMsg = weightInput.parentNode.querySelector('.waste-weight-error');
                        if (errorMsg) {
                            errorMsg.remove();
                        }
                    }
                }
            }

            // ============= –ö–û–ù–ï–¶ –ù–û–í–´–• –ú–ï–¢–û–î–û–í =============

            setupVikModal() {
                const openBtn = document.getElementById('openVikBtn');
                const closeBtn = document.getElementById('closeVikModal');
                const modal = document.getElementById('vikModal');
                
                openBtn.addEventListener('click', () => {
                    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    document.getElementById('mainTitle').textContent = '–ß–ï–ö-–õ–ò–°–¢ –û–ü–ï–†–ê–¶–ò–û–ù–ù–û–ì–û –ö–û–ù–¢–†–û–õ–Ø - –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏ –∏–∑–º–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å';
                    
                    // –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É –í–ò–ö
                    this.createVikForm();
                    
                    // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö
                    this.copyDataFromMainFormToVik();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                });
                
                closeBtn.addEventListener('click', () => {
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ
                    document.getElementById('mainTitle').textContent = '–§–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¶–ï–•–∞';
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.getElementById('mainTitle').textContent = '–§–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¶–ï–•–∞';
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.style.display === 'flex') {
                        document.getElementById('mainTitle').textContent = '–§–æ—Ä–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¶–ï–•–∞';
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö
            copyDataFromMainFormToVik() {
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞—Ç—É –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö
                const dateValue = document.getElementById('dateSelect').value;
                const vikDateInput = document.getElementById('vikDate');
                if (vikDateInput && dateValue) {
                    vikDateInput.value = dateValue;
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö
                const fioValue = document.getElementById('fioView').value || document.getElementById('fio2View').value;
                const vikFioInput = document.getElementById('vikEmployee');
                if (vikFioInput && fioValue) {
                    vikFioInput.value = fioValue;
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö
                const nomenklaturaValue = document.getElementById('nomenklaturaView').value;
                const vikNomenclatureInput = document.getElementById('vikNomenclatureInput');
                if (vikNomenclatureInput && nomenklaturaValue) {
                    vikNomenclatureInput.value = nomenklaturaValue;
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–º–µ–Ω–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö (—Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ)
                const smenaValue = document.getElementById('smenaView').value;
                const vikShiftHidden = document.getElementById('vikShiftHidden');
                if (vikShiftHidden && smenaValue) {
                    vikShiftHidden.value = smenaValue;
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞–±–æ—á–µ–º —Ü–µ–Ω—Ç—Ä–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö (—Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ)
                const centerValue = document.getElementById('centerView').value;
                const vikCenterHidden = document.getElementById('vikCenterHidden');
                if (vikCenterHidden && centerValue) {
                    vikCenterHidden.value = centerValue;
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–∞—Ä—Ç–∏–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö (—Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ)
                const partiyaValue = document.getElementById('partiyaView').value;
                const vikBatchHidden = document.getElementById('vikBatchHidden');
                if (vikBatchHidden && partiyaValue) {
                    vikBatchHidden.value = partiyaValue;
                }
                
                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–ª–∏–Ω–µ –∏–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—É –í–ò–ö
                const harakteristikiValue = document.getElementById('harakteristikiView').value;
                const vikLengthInput = document.getElementById('vikLength');
                
                if (vikLengthInput && harakteristikiValue) {
                    // –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–ª–∏–Ω–µ –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
                    const lengthMatch = harakteristikiValue.match(/(\d+(?:[.,]\d+)?)\s*–º/);
                    if (lengthMatch && lengthMatch[1]) {
                        const lengthValue = lengthMatch[1].replace(',', '.');
                        vikLengthInput.value = lengthValue + ' –º';
                    }
                }
            }

            createVikForm() {
                const container = document.getElementById('vikFormContainer');
                
                // –°–æ–∑–¥–∞–µ–º HTML —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–æ—Ä–º—ã –í–ò–ö
                container.innerHTML = `
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ -->
                    <div class="success-message" id="vikSuccessMessage"></div>
                    <div class="error-message" id="vikErrorMessage"></div>
                    <div class="info-message" id="vikInfoMessage"></div>
                    
                    <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è -->
                    <div class="date-select-group">
                        <h3>üìÖ –î–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã</h3>
                        <div class="header-info">
                            <div class="form-group">
                                <label for="vikDate" class="required">–î–∞—Ç–∞:</label>
                                <input type="text" id="vikDate" class="readonly" readonly required>
                            </div>
                            
                            <div class="form-group">
                                <label for="vikEmployee" class="required">–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:</label>
                                <input type="text" id="vikEmployee" class="readonly" readonly required>
                            </div>
                            
                            <div class="form-group">
                                <label for="vikNomenclatureInput" class="required">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞:</label>
                                <input type="text" id="vikNomenclatureInput" class="readonly" readonly required>
                            </div>
                        </div>
                        
                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
                        <div class="progress-indicator" id="vikProgressIndicator" style="display: none; background-color: #e8f4fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #17a2b8; font-size: 14px;">
                            <strong>–°—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:</strong>
                            <span id="vikProgressStatus">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                    </div>
                    
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
                    <div style="display: none;">
                        <input type="text" id="vikShiftHidden">
                        <input type="text" id="vikCenterHidden">
                        <input type="text" id="vikBatchHidden">
                    </div>
                    
                    <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è) -->
                    <div class="input-group">
                        <div class="form-group">
                            <label for="vikDiameterInput">–î–∏–∞–º–µ—Ç—Ä:</label>
                            <input type="text" id="vikDiameterInput" class="readonly" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="vikSdrInput">SDR:</label>
                            <input type="text" id="vikSdrInput" class="readonly" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="vikLength" class="required">–î–ª–∏–Ω–∞ –æ—Ç—Ä–µ–∑–∫–∞ / –±—É—Ö—Ç—ã:</label>
                            <input type="text" id="vikLength" class="readonly" readonly required>
                        </div>
                    </div>
                    
                    <!-- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã -->
                    <div class="layer-controls">
                        <div class="layer-control">
                            <input type="checkbox" id="vikOuterLayer" checked>
                            <label for="vikOuterLayer">–ù–∞—Ä—É–∂.—Å–ª–æ–π</label>
                        </div>
                        
                        <div class="layer-control">
                            <input type="checkbox" id="vikInnerLayer">
                            <label for="vikInnerLayer">–í–Ω—É—Ç—Ä.—Å–ª–æ–π (–¥–ª—è 3—Ö —Å–ª)</label>
                        </div>
                        
                        <div class="layer-control">
                            <input type="checkbox" id="vikProtect" checked>
                            <label for="vikProtect">–ü–†–û–¢–ï–ö–¢</label>
                        </div>
                    </div>
                    
                    <!-- –ù–æ—Ä–º—ã -->
                    <div class="nomenclature-section">
                        <h3>üìè –ù–æ—Ä–º—ã</h3>
                        <div class="norms-grid">
                            <div class="norm-item">
                                <label>D min:</label>
                                <div class="norm-value" id="vikDMin"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>D max:</label>
                                <div class="norm-value" id="vikDMax"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>–û–≤–∞–ª—å–Ω–æ—Å—Ç—å max:</label>
                                <div class="norm-value" id="vikOvalMax"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ min:</label>
                                <div class="norm-value" id="vikWallThicknessMin"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ max:</label>
                                <div class="norm-value" id="vikWallThicknessMax"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>–¢–æ–ª—â–∏–Ω–∞ –Ω–∞—Ä—É–∂–Ω–æ–≥–æ —Å–ª–æ—è:</label>
                                <div class="norm-value" id="vikOuterLayerThickness"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>–¢–æ–ª—â–∏–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–ª–æ—è:</label>
                                <div class="norm-value" id="vikInnerLayerThickness"></div>
                            </div>
                            
                            <div class="norm-item">
                                <label>–¢–æ–ª—â–∏–Ω–∞ –ü–†–û–¢–ï–ö–¢:</label>
                                <div class="norm-value" id="vikProtectThickness"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (3 –∑–∞–º–µ—Ä–∞) -->
                    <div class="section-title">üìä –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                    
                    <div class="deviation-warning" id="vikDeviationWarning" style="background-color: #fff3cd; color: #856404; padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #ffc107; font-size: 14px; display: none;"></div>
                    
                    <div class="table-responsive">
                        <table class="measurements-table">
                            <thead>
                                <tr>
                                    <th>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</th>
                                    <th class="time-slot-header">8:00</th>
                                    <th class="time-slot-header">12:00</th>
                                    <th class="time-slot-header">16:00</th>
                                </tr>
                            </thead>
                            <tbody id="vikMeasurementsBody">
                                <!-- –°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                `;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –í–ò–ö –∏ –ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï
                this.initVikForm().then(() => {
                    // –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                    this.loadVikDataForCurrentEmployee();
                });
            }

            async loadVikDataForCurrentEmployee() {
                try {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
                    const dateSelect = document.getElementById('vikDateSelect');
                    const currentDate = this.vikCurrentDate || new Date().toISOString().split('T')[0];
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–µ
                    await this.vikLoadDataByDate(currentDate);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º–∞—Ç–∏–≤—ã –∏ —Ñ–æ—Ä–º—É–ª—ã
                    await Promise.all([
                        this.loadNormsFromWebhook(),
                        this.loadFormulasFromWebhook()
                    ]);
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏ –≤—ã–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã
                    const mainEmployeeSelect = document.getElementById('employeeSelect');
                    if (mainEmployeeSelect && mainEmployeeSelect.value && this.vikAllData.length > 0) {
                        const mainEmployeeIndex = mainEmployeeSelect.value;
                        const mainEmployee = this.allData.find(e => String(e.index) === String(mainEmployeeIndex));
                        
                        if (mainEmployee) {
                            // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –≤ –¥–∞–Ω–Ω—ã—Ö –í–ò–ö –ø–æ –§–ò–û –∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ
                            const vikEmployee = this.vikAllData.find(e => {
                                const fioMatch = e['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'] === mainEmployee['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'] ||
                                               e['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'] === mainEmployee['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'] ||
                                               (e['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'] && mainEmployee['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'] && 
                                                e['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'].includes(mainEmployee['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'])) ||
                                               (e['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'] && mainEmployee['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'] && 
                                                e['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'].includes(mainEmployee['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2']));
                                
                                const nomenclatureMatch = e['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] === mainEmployee['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'];
                                const centerMatch = e['–†–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä'] === mainEmployee['–†–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä'];
                                const batchMatch = e['–ü–∞—Ä—Ç–∏—è'] === mainEmployee['–ü–∞—Ä—Ç–∏—è'];
                                
                                return (fioMatch && nomenclatureMatch) || (centerMatch && batchMatch);
                            });
                            
                            if (vikEmployee && vikEmployee.index) {
                                // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã
                                this.copyDataFromMainFormToVik();
                                
                                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∏–∞–º–µ—Ç—Ä–∞ –∏ SDR
                                this.vikParseNomenclature(vikEmployee['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] || '');
                                
                                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º—ã –¥–ª—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
                                await this.vikLoadNormsForNomenclature(vikEmployee['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] || '');
                                
                                // –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á–µ—Ç –Ω–æ—Ä–º –ø–æ –¥–∏–∞–º–µ—Ç—Ä—É –∏ SDR
                                const diameter = document.getElementById('vikDiameterInput').value;
                                const sdr = document.getElementById('vikSdrInput').value;
                                if (diameter && sdr) {
                                    await this.vikLoadNormsForDiameterSDR();
                                }
                            }
                        }
                    }
                    
                    this.vikShowSuccess('–§–æ—Ä–º–∞ –í–ò–ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
                    this.vikSetupAutoUpdateNorms();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –í–ò–ö:', error);
                    this.vikShowError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            }

            vikSetupAutoUpdateNorms() {
                let lastDiameter = '';
                let lastSdr = '';
                
                // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä–∞ –∏ SDR
                setInterval(() => {
                    const diameterInput = document.getElementById('vikDiameterInput');
                    const sdrInput = document.getElementById('vikSdrInput');
                    
                    if (!diameterInput || !sdrInput) return;
                    
                    const diameter = diameterInput.value;
                    const sdr = sdrInput.value;
                    
                    if (diameter && sdr && (diameter !== lastDiameter || sdr !== lastSdr)) {
                        lastDiameter = diameter;
                        lastSdr = sdr;
                        this.vikLoadNormsForDiameterSDR();
                    }
                }, 1000);
                
                // –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è —É–∂–µ –µ—Å—Ç—å
                const diameterInput = document.getElementById('vikDiameterInput');
                const sdrInput = document.getElementById('vikSdrInput');
                
                if (diameterInput && diameterInput.value && sdrInput && sdrInput.value) {
                    setTimeout(() => {
                        this.vikLoadNormsForDiameterSDR();
                    }, 500);
                }
            }

            async initVikForm() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –í–ò–ö
                this.setupVikEventHandlers();
                
                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏–π
                this.createVikMeasurementsTable();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                await this.vikCheckProgress();
            }

            createVikMeasurementsTable() {
                const tableBody = document.getElementById('vikMeasurementsBody');
                if (!tableBody) return;
                
                // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏
                tableBody.innerHTML = '';
                
                const measurements = [
                    { label: '–ù–æ–º–µ—Ä —Ç—Ä—É–±—ã –ø/–ø', type: 'text', placeholder: '‚Ññ', required: true, idBase: 'pipe-number' },
                    { label: '–î–∏–∞–º–µ—Ç—Ä', type: 'number', placeholder: '–º–º', required: true, idBase: 'diameter', step: '0.1' },
                    { label: '–û–≤–∞–ª—å–Ω–æ—Å—Ç—å', type: 'number', placeholder: '–º–º', required: true, idBase: 'oval', step: '0.1' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ min', type: 'number', placeholder: '–º–º', required: true, idBase: 'wall-min', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ max', type: 'number', placeholder: '–º–º', required: true, idBase: 'wall-max', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ –Ω–∞—Ä—É–∂–Ω–æ–≥–æ —Å–ª–æ—è min', type: 'number', placeholder: '–º–º', required: false, idBase: 'outer-min', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ –Ω–∞—Ä—É–∂–Ω–æ–≥–æ —Å–ª–æ—è max', type: 'number', placeholder: '–º–º', required: false, idBase: 'outer-max', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–ª–æ—è min', type: 'number', placeholder: '–º–º', required: false, idBase: 'inner-min', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–ª–æ—è max', type: 'number', placeholder: '–º–º', required: false, idBase: 'inner-max', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ –ü–†–û–¢–ï–ö–¢ min', type: 'number', placeholder: '–º–º', required: false, idBase: 'protect-min', step: '0.01' },
                    { label: '–¢–æ–ª—â–∏–Ω–∞ –ü–†–û–¢–ï–ö–¢ max', type: 'number', placeholder: '–º–º', required: false, idBase: 'protect-max', step: '0.01' },
                    { label: '–î–ª–∏–Ω–∞', type: 'number', placeholder: '–º', required: true, idBase: 'length', step: '0.01' },
                    { label: '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –Ω–∞—Ä—É–∂–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏', type: 'select', options: ['–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç', '–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç'], required: true, idBase: 'appearance-outer' },
                    { label: '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏', type: 'select', options: ['–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç', '–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç'], required: true, idBase: 'appearance-inner' },
                    { label: '–û—Å–º–æ—Ç—Ä —Ç–æ—Ä—Ü–æ–≤', type: 'select', options: ['–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç', '–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç'], required: true, idBase: 'ends' },
                    { label: '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞', type: 'select', options: ['–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç', '–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç'], required: true, idBase: 'marking' },
                    { label: '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞–º–∏', type: 'select', options: ['–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç', '–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç'], required: true, idBase: 'marking-distance' },
                    { label: '–ù–∞–ª–∏—á–∏–µ –∑–∞–≥–ª—É—à–µ–∫, —Ä–∞—Å–ø–æ—Ä–æ–∫, –ø–ª–µ–Ω–∫–∏', type: 'checkbox', required: false, idBase: 'plugs' }
                ];
                
                measurements.forEach((measurement) => {
                    const row = document.createElement('tr');
                    
                    // –Ø—á–µ–π–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
                    const labelCell = document.createElement('td');
                    labelCell.textContent = measurement.label;
                    row.appendChild(labelCell);
                    
                    // –Ø—á–µ–π–∫–∏ –¥–ª—è —Ç—Ä–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                    for (let i = 1; i <= 3; i++) {
                        const timeCell = document.createElement('td');
                        const timeSlot = i === 1 ? '8:00' : i === 2 ? '12:00' : '16:00';
                        
                        if (measurement.type === 'select') {
                            const select = document.createElement('select');
                            select.className = `measurement-input ${i > 1 ? 'disabled-field' : ''}`;
                            select.id = `${measurement.idBase}-${i}`;
                            select.dataset.time = timeSlot;
                            select.disabled = i > 1;
                            if (measurement.required) select.required = true;
                            
                            const defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.textContent = '-- –í—ã–±–µ—Ä–∏—Ç–µ --';
                            select.appendChild(defaultOption);
                            
                            measurement.options.forEach(option => {
                                const optionEl = document.createElement('option');
                                optionEl.value = option;
                                optionEl.textContent = option;
                                select.appendChild(optionEl);
                            });
                            
                            timeCell.appendChild(select);
                        } else if (measurement.type === 'checkbox') {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = `measurement-input ${i > 1 ? 'disabled-field' : ''}`;
                            checkbox.id = `${measurement.idBase}-${i}`;
                            checkbox.dataset.time = timeSlot;
                            checkbox.disabled = i > 1;
                            timeCell.appendChild(checkbox);
                        } else {
                            const input = document.createElement('input');
                            input.type = measurement.type;
                            input.className = `measurement-input ${i > 1 ? 'disabled-field' : ''}`;
                            input.id = `${measurement.idBase}-${i}`;
                            input.dataset.time = timeSlot;
                            input.placeholder = measurement.placeholder;
                            input.disabled = i > 1;
                            if (measurement.required) input.required = true;
                            if (measurement.step) input.step = measurement.step;
                            timeCell.appendChild(input);
                        }
                        
                        row.appendChild(timeCell);
                    }
                    
                    tableBody.appendChild(row);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
                const submitRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                submitRow.appendChild(emptyCell);
                
                for (let i = 1; i <= 3; i++) {
                    const timeSlot = i === 1 ? '8:00' : i === 2 ? '12:00' : '16:00';
                    const buttonCell = document.createElement('td');
                    
                    const button = document.createElement('button');
                    button.className = `btn btn-submit ${i > 1 ? 'disabled-field' : ''}`;
                    button.id = `vikSubmitBtn${i}`;
                    button.dataset.time = timeSlot;
                    button.disabled = i > 1;
                    button.textContent = `üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å ${timeSlot}`;
                    button.onclick = () => this.vikSubmitMeasurements(timeSlot);
                    
                    buttonCell.appendChild(button);
                    submitRow.appendChild(buttonCell);
                }
                
                tableBody.appendChild(submitRow);
            }

            setupVikEventHandlers() {
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –í–ò–ö
                const outerLayer = document.getElementById('vikOuterLayer');
                const innerLayer = document.getElementById('vikInnerLayer');
                const protect = document.getElementById('vikProtect');
                
                if (outerLayer) outerLayer.addEventListener('change', () => this.vikUpdateLayerRequirements());
                if (innerLayer) innerLayer.addEventListener('change', () => this.vikUpdateLayerRequirements());
                if (protect) protect.addEventListener('change', () => this.vikUpdateLayerRequirements());
                
                // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –¥–∏–∞–º–µ—Ç—Ä–∞ –∏ SDR
                const diameterInput = document.getElementById('vikDiameterInput');
                const sdrInput = document.getElementById('vikSdrInput');
                
                if (diameterInput && sdrInput) {
                    diameterInput.addEventListener('change', () => {
                        if (diameterInput.value && sdrInput.value) {
                            this.vikLoadNormsForDiameterSDR();
                        }
                    });
                    
                    sdrInput.addEventListener('change', () => {
                        if (diameterInput.value && sdrInput.value) {
                            this.vikLoadNormsForDiameterSDR();
                        }
                    });
                }
                
                this.vikInitializeMeasurementState();
            }

            // =============== –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º—ã –í–ò–ö (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) ===============
            async vikLoadDataByDate(date) {
                if (!date) return;
                this.vikShowInfo('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...');
                
                try {
                    const response = await fetch(`${this.n8nWebhookUrl}?date=${encodeURIComponent(date)}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const result = await response.json();
                    
                    if (result.success && Array.isArray(result.allData) && result.allData.length > 0) {
                        this.vikAllData = result.allData;
                        this.vikEmployeeData = Array.isArray(result.employees) ? result.employees : [];
                        
                        this.vikShowSuccess(`–ù–∞–π–¥–µ–Ω–æ ${this.vikEmployeeData.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`);
                    } else {
                        this.vikAllData = [];
                        this.vikEmployeeData = [];
                        this.vikShowInfo('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É');
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –í–ò–ö:', e);
                    this.vikShowError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            }

            vikParseNomenclature(nomenclature) {
                if (!nomenclature) {
                    const diameterInput = document.getElementById('vikDiameterInput');
                    const sdrInput = document.getElementById('vikSdrInput');
                    if (diameterInput) diameterInput.value = '';
                    if (sdrInput) sdrInput.value = '';
                    this.vikClearNormFields();
                    return;
                }
                
                const sdrMatch = nomenclature.match(/SDR\s*(\d+(?:[.,]\d+)?)/i);
                if (sdrMatch && sdrMatch[1]) {
                    const sdrValue = parseFloat(sdrMatch[1].replace(',', '.'));
                    if (!isNaN(sdrValue)) {
                        const sdrInput = document.getElementById('vikSdrInput');
                        if (sdrInput) sdrInput.value = sdrValue;
                    }
                }
                
                const diameterMatch = nomenclature.match(/(?:-|—Ö)\s*(\d+(?:[.,]\d+)?)(?:\s*—Ö|$)/i);
                if (diameterMatch && diameterMatch[1]) {
                    const diameterValue = parseFloat(diameterMatch[1].replace(',', '.'));
                    if (!isNaN(diameterValue)) {
                        const diameterInput = document.getElementById('vikDiameterInput');
                        if (diameterInput) diameterInput.value = diameterValue;
                    }
                }
                
                const diameterInput = document.getElementById('vikDiameterInput');
                if (!diameterInput || !diameterInput.value || isNaN(parseFloat(diameterInput.value))) {
                    const allNumbers = nomenclature.match(/\d+(?:[.,]\d+)?/g);
                    if (allNumbers) {
                        for (let num of allNumbers) {
                            const numValue = parseFloat(num.replace(',', '.'));
                            if (!isNaN(numValue) && numValue >= 16 && numValue <= 1200) {
                                if (diameterInput) diameterInput.value = numValue;
                                break;
                            }
                        }
                    }
                }
            }

            async vikLoadNormsForNomenclature(nomenclature) {
                if (!nomenclature) return;
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º—ã –ø–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ
                    const response = await fetch(`${this.NORMS_WEBHOOK_URL}?nomenclature=${encodeURIComponent(nomenclature)}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.norms) {
                            this.vikApplyNorms(result.norms);
                            this.vikShowSuccess('–ù–æ—Ä–º–∞—Ç–∏–≤—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                            return;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –Ω–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ –¥–∏–∞–º–µ—Ç—Ä—É –∏ SDR
                    const diameter = document.getElementById('vikDiameterInput').value;
                    const sdr = document.getElementById('vikSdrInput').value;
                    
                    if (diameter && sdr) {
                        await this.vikLoadNormsForDiameterSDR();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', error);
                    this.vikShowError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤');
                }
            }

            vikApplyNorms(norms) {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
                const normFields = {
                    'vikDMin': norms.d_min,
                    'vikDMax': norms.d_max,
                    'vikOvalMax': norms.oval_max,
                    'vikWallThicknessMin': norms.wall_thickness_min,
                    'vikWallThicknessMax': norms.wall_thickness_max,
                    'vikOuterLayerThickness': norms.outer_layer,
                    'vikInnerLayerThickness': norms.inner_layer,
                    'vikProtectThickness': norms.protect
                };
                
                for (const [fieldId, value] of Object.entries(normFields)) {
                    const element = document.getElementById(fieldId);
                    if (element && value !== undefined) {
                        element.textContent = value;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—â–∏–Ω —Å–ª–æ–µ–≤
                this.vikUpdateLayerThicknessDisplay();
            }

            vikClearEmployeeFields() {
                // –ü–æ–ª—è —Ç–µ–ø–µ—Ä—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ readonly
                const dateInput = document.getElementById('vikDate');
                if (dateInput) dateInput.value = '';
                
                const fioInput = document.getElementById('vikEmployee');
                if (fioInput) fioInput.value = '';
                
                const nomenclatureInput = document.getElementById('vikNomenclatureInput');
                if (nomenclatureInput) nomenclatureInput.value = '';
                
                // –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                const shiftHidden = document.getElementById('vikShiftHidden');
                if (shiftHidden) shiftHidden.value = '';
                
                const centerHidden = document.getElementById('vikCenterHidden');
                if (centerHidden) centerHidden.value = '';
                
                const batchHidden = document.getElementById('vikBatchHidden');
                if (batchHidden) batchHidden.value = '';
                
                const diameterInput = document.getElementById('vikDiameterInput');
                if (diameterInput) diameterInput.value = '';
                
                const sdrInput = document.getElementById('vikSdrInput');
                if (sdrInput) sdrInput.value = '';
                
                // –ü–æ–ª–µ "–î–ª–∏–Ω–∞ –æ—Ç—Ä–µ–∑–∫–∞ / –±—É—Ö—Ç—ã:" —Ç–µ–ø–µ—Ä—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∏ readonly
                const lengthInput = document.getElementById('vikLength');
                if (lengthInput) lengthInput.value = '';
                
                this.vikClearNormFields();
            }

            vikClearNormFields() {
                const normFields = [
                    'vikDMin', 'vikDMax', 'vikOvalMax', 'vikWallThicknessMin', 
                    'vikWallThicknessMax', 'vikOuterLayerThickness', 
                    'vikInnerLayerThickness', 'vikProtectThickness'
                ];
                
                normFields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = '';
                    }
                });
            }

            vikInitializeMeasurementState() {
                // –í–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ 8:00, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–∫–ª—é—á–∞–µ–º
                this.vikEnableTimeSlot('8:00');
                this.vikDisableTimeSlot('12:00');
                this.vikDisableTimeSlot('16:00');
                
                // –ö–Ω–æ–ø–∫–∏
                const submitBtn1 = document.getElementById('vikSubmitBtn1');
                const submitBtn2 = document.getElementById('vikSubmitBtn2');
                const submitBtn3 = document.getElementById('vikSubmitBtn3');
                
                if (submitBtn1) {
                    submitBtn1.disabled = false;
                    submitBtn1.classList.remove('disabled-field');
                }
                
                if (submitBtn2) {
                    submitBtn2.disabled = true;
                    submitBtn2.classList.add('disabled-field');
                }
                
                if (submitBtn3) {
                    submitBtn3.disabled = true;
                    submitBtn3.classList.add('disabled-field');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–ª—è–º —Å–ª–æ–µ–≤
                this.vikUpdateLayerRequirements();
                
                this.vikShowInfo('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–º–µ—Ä–∞ 8:00. –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∑–∞–º–µ—Ä 12:00.');
            }

            vikEnableTimeSlot(timeSlot) {
                const suffix = timeSlot === '8:00' ? '1' : timeSlot === '12:00' ? '2' : '3';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Å–ª–æ—Ç
                if (this.submittedSlots.has(timeSlot)) {
                    this.vikLockTimeSlot(timeSlot);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–ª–æ—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                if (!this.vikIsTimeSlotEnabled(timeSlot)) {
                    this.vikDisableTimeSlot(timeSlot);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π
                const measurementInputs = document.querySelectorAll(`#vikFormContainer [data-time="${timeSlot}"]`);
                measurementInputs.forEach(input => {
                    if (input.tagName === 'INPUT' || input.tagName === 'SELECT') {
                        input.disabled = false;
                        input.classList.remove('disabled-field', 'locked-field');
                    }
                });
                
                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
                const submitBtn = document.getElementById(`vikSubmitBtn${suffix}`);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('disabled-field');
                    submitBtn.textContent = `üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å ${timeSlot}`;
                }
            }

            vikDisableTimeSlot(timeSlot) {
                const suffix = timeSlot === '8:00' ? '1' : timeSlot === '12:00' ? '2' : '3';
                
                // –í—Å–µ –ø–æ–ª—è –≤ —ç—Ç–æ–º —Å–ª–æ—Ç–µ –¥–µ–ª–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∏ —Å–µ—Ä—ã–º–∏
                const measurementInputs = document.querySelectorAll(`#vikFormContainer [data-time="${timeSlot}"]`);
                measurementInputs.forEach(input => {
                    if (input.tagName === 'INPUT' || input.tagName === 'SELECT') {
                        input.disabled = true;
                        input.classList.add('disabled-field');
                    }
                });
                
                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
                const submitBtn = document.getElementById(`vikSubmitBtn${suffix}`);
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('disabled-field');
                }
            }

            vikLockTimeSlot(timeSlot) {
                const suffix = timeSlot === '8:00' ? '1' : timeSlot === '12:00' ? '2' : '3';
                
                // –í—Å–µ –ø–æ–ª—è –≤ —ç—Ç–æ–º —Å–ª–æ—Ç–µ –¥–µ–ª–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏, –Ω–æ –≤–∏–¥–∏–º—ã–º–∏
                const measurementInputs = document.querySelectorAll(`#vikFormContainer [data-time="${timeSlot}"]`);
                measurementInputs.forEach(input => {
                    if (input.tagName === 'INPUT' || input.tagName === 'SELECT') {
                        input.disabled = true;
                        input.readOnly = true;
                        input.classList.add('locked-field');
                        input.classList.remove('disabled-field');
                    }
                });
                
                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
                const submitBtn = document.getElementById(`vikSubmitBtn${suffix}`);
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('disabled-field');
                    submitBtn.textContent = `‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${timeSlot}`;
                }
            }

            vikUpdateLayerRequirements() {
                const outerLayerChecked = document.getElementById('vikOuterLayer') ? document.getElementById('vikOuterLayer').checked : false;
                const innerLayerChecked = document.getElementById('vikInnerLayer') ? document.getElementById('vikInnerLayer').checked : false;
                const protectChecked = document.getElementById('vikProtect') ? document.getElementById('vikProtect').checked : false;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—â–∏–Ω —Å–ª–æ–µ–≤
                this.vikUpdateLayerThicknessDisplay();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–ª—è–º –≤ —Ç–∞–±–ª–∏—Ü–µ
                ['1', '2', '3'].forEach(suffix => {
                    const timeSlot = suffix === '1' ? '8:00' : suffix === '2' ? '12:00' : '16:00';
                    
                    // –ï—Å–ª–∏ —Å–ª–æ—Ç —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    if (this.submittedSlots.has(timeSlot)) {
                        return;
                    }
                    
                    // –ï—Å–ª–∏ —Å–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
                    if (this.vikIsTimeSlotEnabled(timeSlot)) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π —Å–ª–æ–µ–≤
                        const outerMin = document.getElementById(`outer-min-${suffix}`);
                        const outerMax = document.getElementById(`outer-max-${suffix}`);
                        const innerMin = document.getElementById(`inner-min-${suffix}`);
                        const innerMax = document.getElementById(`inner-max-${suffix}`);
                        const protectMin = document.getElementById(`protect-min-${suffix}`);
                        const protectMax = document.getElementById(`protect-max-${suffix}`);
                        
                        if (outerMin && outerMax) {
                            outerMin.disabled = !outerLayerChecked;
                            outerMax.disabled = !outerLayerChecked;
                            if (!outerLayerChecked) {
                                outerMin.value = '';
                                outerMax.value = '';
                            }
                        }
                        
                        if (innerMin && innerMax) {
                            innerMin.disabled = !innerLayerChecked;
                            innerMax.disabled = !innerLayerChecked;
                            if (!innerLayerChecked) {
                                innerMin.value = '';
                                innerMax.value = '';
                            }
                        }
                        
                        if (protectMin && protectMax) {
                            protectMin.disabled = !protectChecked;
                            protectMax.disabled = !protectChecked;
                            if (!protectChecked) {
                                protectMin.value = '';
                                protectMax.value = '';
                            }
                        }
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ—Ä–º—ã –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∏–∞–º–µ—Ç—Ä –∏ SDR
                const diameterInput = document.getElementById('vikDiameterInput');
                const sdrInput = document.getElementById('vikSdrInput');
                if (diameterInput && diameterInput.value && sdrInput && sdrInput.value) {
                    this.vikLoadNormsForDiameterSDR();
                }
            }

            vikUpdateLayerThicknessDisplay() {
                const outerLayerChecked = document.getElementById('vikOuterLayer') ? document.getElementById('vikOuterLayer').checked : false;
                const innerLayerChecked = document.getElementById('vikInnerLayer') ? document.getElementById('vikInnerLayer').checked : false;
                const protectChecked = document.getElementById('vikProtect') ? document.getElementById('vikProtect').checked : false;
                
                const outerLayerThickness = document.getElementById('vikOuterLayerThickness');
                const innerLayerThickness = document.getElementById('vikInnerLayerThickness');
                const protectThickness = document.getElementById('vikProtectThickness');
                
                if (outerLayerThickness) {
                    if (!outerLayerChecked) {
                        outerLayerThickness.textContent = '–Ω–µ—Ç';
                    } else if (outerLayerThickness.textContent === '') {
                        outerLayerThickness.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    }
                }
                
                if (innerLayerThickness) {
                    if (!innerLayerChecked) {
                        innerLayerThickness.textContent = '–Ω–µ—Ç';
                    } else if (innerLayerThickness.textContent === '') {
                        innerLayerThickness.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    }
                }
                
                if (protectThickness) {
                    if (!protectChecked) {
                        protectThickness.textContent = '–Ω–µ—Ç';
                    } else if (protectThickness.textContent === '') {
                        protectThickness.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    }
                }
            }

            vikIsTimeSlotEnabled(timeSlot) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ —É–∂–µ —Å–ª–æ—Ç
                if (this.submittedSlots.has(timeSlot)) {
                    return false;
                }
                
                // 8:00 –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω, –µ—Å–ª–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                if (timeSlot === '8:00') {
                    return true;
                }
                
                // 12:00 –¥–æ—Å—Ç—É–ø–µ–Ω, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω 8:00
                if (timeSlot === '12:00') {
                    return this.submittedSlots.has('8:00');
                }
                
                // 16:00 –¥–æ—Å—Ç—É–ø–µ–Ω, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω 12:00
                if (timeSlot === '16:00') {
                    return this.submittedSlots.has('12:00');
                }
                
                return false;
            }

            async vikCheckProgress() {
                // –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã
                const date = document.getElementById('dateSelect').value;
                const fioValue = document.getElementById('fioView').value || document.getElementById('fio2View').value;
                
                if (!date || !fioValue) {
                    return;
                }
                
                try {
                    this.vikShowInfo('–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è...');
                    
                    const progressIndicator = document.getElementById('vikProgressIndicator');
                    if (progressIndicator) {
                        progressIndicator.style.display = 'block';
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ –í–ò–ö
                    let hash = 0;
                    for (let i = 0; i < fioValue.length; i++) {
                        const char = fioValue.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    const stableEmployeeId = `emp_${Math.abs(hash)}`;
                    
                    const response = await fetch(`${this.PROGRESS_WEBHOOK_URL}?date=${encodeURIComponent(date)}&employeeid=${encodeURIComponent(stableEmployeeId)}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.submittedSlots = new Set(result.filledSlots || []);
                            this.slotData = result.slotData || {};
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                            this.vikUpdateProgressIndicator();
                            
                            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                            this.vikFillSlotData();
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤
                            this.vikUpdateTimeSlotsAvailability();
                            
                            if (this.submittedSlots.size > 0) {
                                this.vikShowSuccess(`–ù–∞–π–¥–µ–Ω–æ ${this.submittedSlots.size} –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π(—ã—Ö) —Å–ª–æ—Ç(–æ–≤)`);
                            } else {
                                this.vikShowInfo('–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–∏–Ω–∞–π—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å 8:00.');
                            }
                        } else {
                            this.vikShowInfo('–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–∏–Ω–∞–π—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å 8:00.');
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                    this.vikShowError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
                }
            }

            vikUpdateProgressIndicator() {
                const progressStatus = document.getElementById('vikProgressStatus');
                if (!progressStatus) return;
                
                const totalSlots = 3;
                const filledSlots = this.submittedSlots.size;
                
                let statusText = '';
                
                if (filledSlots === 0) {
                    statusText = '–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å 8:00.';
                } else if (filledSlots === totalSlots) {
                    statusText = '–í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!';
                } else {
                    const currentSlot = this.vikGetNextSlot();
                    statusText = `–ó–∞–ø–æ–ª–Ω–µ–Ω–æ ${filledSlots} –∏–∑ ${totalSlots} —Å–ª–æ—Ç–æ–≤. –¢–µ–∫—É—â–∏–π —Å–ª–æ—Ç: ${currentSlot}`;
                }
                
                progressStatus.textContent = statusText;
            }

            vikGetNextSlot() {
                const slots = ['8:00', '12:00', '16:00'];
                
                for (let slot of slots) {
                    if (!this.submittedSlots.has(slot)) {
                        return slot;
                    }
                }
                
                return '–≤—Å–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã';
            }

            vikFillSlotData() {
                if (!this.slotData || Object.keys(this.slotData).length === 0) {
                    return;
                }
                
                // –ú–∞–ø–ø–∏–Ω–≥ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤ –¥–ª—è —Å–ª–æ—Ç–æ–≤
                const suffixMap = {
                    '8:00': '-1',
                    '12:00': '-2', 
                    '16:00': '-3'
                };
                
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —Å–ª–æ—Ç–∞–º
                Object.keys(this.slotData).forEach(slot => {
                    const data = this.slotData[slot];
                    const suffix = suffixMap[slot];
                    
                    if (!data || !suffix) return;
                    
                    // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∏–∑ –ë–î –≤ ID –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
                    const fieldMapping = {
                        '–ù–æ–º–µ—Ä —Ç—Ä—É–±—ã –ø/–ø': 'pipe-number',
                        '–î–∏–∞–º–µ—Ç—Ä': 'diameter',
                        '–û–≤–∞–ª—å–Ω–æ—Å—Ç—å': 'oval',
                        '–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ min': 'wall-min',
                        '–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ max': 'wall-max',
                        '–¢–æ–ª—â–∏–Ω–∞ –Ω–∞—Ä—É–∂–Ω–æ–≥–æ —Å–ª–æ—è min': 'outer-min',
                        '–¢–æ–ª—â–∏–Ω–∞ –Ω–∞—Ä—É–∂–Ω–æ–≥–æ —Å–ª–æ—è max': 'outer-max',
                        '–¢–æ–ª—â–∏–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–ª–æ—è min': 'inner-min',
                        '–¢–æ–ª—â–∏–Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–ª–æ—è max': 'inner-max',
                        '–¢–æ–ª—â–∏–Ω–∞ –ü–†–û–¢–ï–ö–¢ min': 'protect-min',
                        '–¢–æ–ª—â–∏–Ω–∞ –ü–†–û–¢–ï–ö–¢ max': 'protect-max',
                        '–î–ª–∏–Ω–∞': 'length',
                        '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –Ω–∞—Ä—É–∂–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏': 'appearance-outer',
                        '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏': 'appearance-inner',
                        '–û—Å–º–æ—Ç—Ä —Ç–æ—Ä—Ü–æ–≤': 'ends',
                        '–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞': 'marking',
                        '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞–º–∏': 'marking-distance',
                        '–ù–∞–ª–∏—á–∏–µ –∑–∞–≥–ª—É—à–µ–∫, —Ä–∞—Å–ø–æ—Ä–æ–∫, –ø–ª–µ–Ω–∫–∏': 'plugs'
                    };
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                    Object.keys(fieldMapping).forEach(dbField => {
                        const fieldId = fieldMapping[dbField] + suffix;
                        const element = document.getElementById(fieldId);
                        
                        if (element && data[dbField] !== undefined && data[dbField] !== null) {
                            if (element.type === 'checkbox') {
                                element.checked = Boolean(data[dbField]);
                            } else if (element.tagName === 'SELECT') {
                                // –î–ª—è select –∏—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                                for (let i = 0; i < element.options.length; i++) {
                                    if (element.options[i].value === String(data[dbField])) {
                                        element.value = String(data[dbField]);
                                        break;
                                    }
                                }
                            } else {
                                element.value = String(data[dbField]);
                            }
                        }
                    });
                    
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–ª–æ—Ç –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                    this.vikLockTimeSlot(slot);
                });
            }

            vikUpdateTimeSlotsAvailability() {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Å–ª–æ—Ç
                const timeSlots = ['8:00', '12:00', '16:00'];
                
                timeSlots.forEach(slot => {
                    if (this.submittedSlots.has(slot)) {
                        // –°–ª–æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω - –±–ª–æ–∫–∏—Ä—É–µ–º
                        this.vikLockTimeSlot(slot);
                    } else if (this.vikIsTimeSlotEnabled(slot)) {
                        // –°–ª–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                        this.vikEnableTimeSlot(slot);
                    } else {
                        // –°–ª–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                        this.vikDisableTimeSlot(slot);
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const nextSlot = this.vikGetNextSlot();
                if (nextSlot !== '–≤—Å–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã') {
                    this.vikShowInfo(`–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–º–µ—Ä–∞ ${nextSlot}.`);
                } else {
                    this.vikShowSuccess('–í—Å–µ –∑–∞–º–µ—Ä—ã –∑–∞ —Å–º–µ–Ω—É —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
                }
            }

            async vikLoadNormsForDiameterSDR() {
                const diameter = document.getElementById('vikDiameterInput').value;
                const sdr = document.getElementById('vikSdrInput').value;
                
                if (!diameter || !sdr) {
                    this.vikShowError('–í–≤–µ–¥–∏—Ç–µ –î–∏–∞–º–µ—Ç—Ä –∏ SDR');
                    return;
                }
                
                try {
                    this.vikShowInfo(`–ü–æ–∏—Å–∫ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –¥–ª—è –î–∏–∞–º–µ—Ç—Ä=${diameter}, SDR=${sdr}...`);
                    
                    if (this.normsData && this.normsData.length > 0) {
                        const norm = this.vikFindNormInLoadedData(parseFloat(diameter), parseFloat(sdr));
                        if (norm) {
                            this.vikDisplayNorm(norm);
                            this.vikShowSuccess(`–ù–∞–π–¥–µ–Ω—ã –Ω–æ—Ä–º—ã –¥–ª—è –¥–∏–∞–º–µ—Ç—Ä–∞ ${diameter} –∏ SDR ${sdr}`);
                            return;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –Ω–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
                    this.vikShowInfo(`–ù–æ—Ä–º–∞—Ç–∏–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º...`);
                    const calculatedNorm = this.vikCalculateNormForDiameterSDR(parseFloat(diameter), parseFloat(sdr));
                    this.vikDisplayNorm(calculatedNorm);
                    this.vikShowSuccess(`–†–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–æ—Ä–º—ã –¥–ª—è –¥–∏–∞–º–µ—Ç—Ä–∞ ${diameter} –∏ SDR ${sdr}`);
                    
                } catch (error) {
                    const calculatedNorm = this.vikCalculateNormForDiameterSDR(parseFloat(diameter), parseFloat(sdr));
                    this.vikDisplayNorm(calculatedNorm);
                    this.vikShowInfo(`–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è`);
                }
            }

            vikFindNormInLoadedData(diameterNum, sdrNum) {
                if (!this.normsData || this.normsData.length === 0) {
                    return null;
                }
                
                for (let i = 0; i < this.normsData.length; i++) {
                    const item = this.normsData[i];
                    const itemDiameter = parseFloat(item.diameter);
                    const itemSdr = parseFloat(item.sdr);
                    
                    if (itemDiameter === diameterNum && itemSdr === sdrNum) {
                        return item;
                    }
                }
                
                return null;
            }

            vikCalculateNormForDiameterSDR(diameterNum, sdrNum) {
                const formulas = this.calculationFormulas || this.vikGetDefaultFormulas();
                
                const nominalThickness = diameterNum / sdrNum;
                
                const calculate = (formula, baseValue) => {
                    if (!formula) return '';
                    if (typeof formula === 'number') return formula.toFixed(1);
                    if (typeof formula === 'string') {
                        try {
                            const expression = formula.replace(/value/gi, baseValue);
                            const result = eval(expression);
                            return parseFloat(result).toFixed(1);
                        } catch (e) {
                            return '';
                        }
                    }
                    return '';
                };
                
                return {
                    diameter: diameterNum,
                    sdr: sdrNum,
                    demMin: calculate(formulas.demMin, diameterNum) || diameterNum.toFixed(1),
                    demMax: calculate(formulas.demMax, diameterNum) || (diameterNum * 1.006).toFixed(1),
                    ovalMax: calculate(formulas.ovalMax, diameterNum) || (diameterNum * 0.035).toFixed(1),
                    emin: calculate(formulas.emin, nominalThickness) || (nominalThickness * 1.006).toFixed(1),
                    emax: calculate(formulas.emax, nominalThickness) || (nominalThickness * 1.114).toFixed(1),
                    protect: formulas.protect || '2.2',
                    outerLayer: formulas.outerLayer || '3.30',
                    innerLayer: formulas.innerLayer || ''
                };
            }

            vikGetDefaultFormulas() {
                return {
                    demMin: 'value * 1.000',
                    demMax: 'value * 1.006',
                    ovalMax: 'value * 0.035',
                    emin: 'value * 1.006',
                    emax: 'value * 1.114',
                    protect: '2.2',
                    outerLayer: '3.30',
                    innerLayer: ''
                };
            }

            vikDisplayNorm(norm) {
                if (!norm) {
                    this.vikClearNormFields();
                    return;
                }
                
                const dMin = document.getElementById('vikDMin');
                const dMax = document.getElementById('vikDMax');
                const ovalMax = document.getElementById('vikOvalMax');
                const wallThicknessMin = document.getElementById('vikWallThicknessMin');
                const wallThicknessMax = document.getElementById('vikWallThicknessMax');
                const outerLayerThickness = document.getElementById('vikOuterLayerThickness');
                const innerLayerThickness = document.getElementById('vikInnerLayerThickness');
                const protectThickness = document.getElementById('vikProtectThickness');
                
                if (dMin) dMin.textContent = norm.demMin || '';
                if (dMax) dMax.textContent = norm.demMax || '';
                if (ovalMax) ovalMax.textContent = norm.ovalMax || '';
                if (wallThicknessMin) wallThicknessMin.textContent = norm.emin || '';
                if (wallThicknessMax) wallThicknessMax.textContent = norm.emax || '';
                if (outerLayerThickness) outerLayerThickness.textContent = norm.outerLayer || '';
                if (innerLayerThickness) innerLayerThickness.textContent = norm.innerLayer || '';
                if (protectThickness) protectThickness.textContent = norm.protect || '';
                
                this.vikUpdateLayerThicknessDisplay();
            }

            async vikSubmitMeasurements(timeSlot) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (!this.vikValidateAllRequiredFields(timeSlot)) {
                    this.vikShowError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ ' + timeSlot);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º
                const deviations = this.vikCheckForDeviations(timeSlot);
                
                if (deviations.length > 0) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    this.pendingTimeSlot = timeSlot;
                    this.pendingDeviations = deviations;
                    this.pendingMeasurementData = this.vikCollectMeasurementData(timeSlot);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
                    this.vikHighlightDeviationFields(timeSlot, deviations);
                    this.vikShowDeviationModal(deviations);
                } else {
                    // –ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
                    await this.vikSendMeasurementsData(timeSlot);
                }
            }

            vikValidateAllRequiredFields(timeSlot) {
                let isValid = true;
                const suffix = timeSlot === '8:00' ? '-1' : timeSlot === '12:00' ? '-2' : '-3';
                
                const requiredFields = [
                    'pipe-number',
                    'diameter',
                    'oval',
                    'wall-min',
                    'wall-max',
                    'length',
                    'appearance-outer',
                    'appearance-inner',
                    'ends',
                    'marking',
                    'marking-distance'
                ];
                
                requiredFields.forEach(field => {
                    const element = document.getElementById(field + suffix);
                    if (element) {
                        if (element.tagName === 'SELECT') {
                            if (!element.value) {
                                element.classList.add('error-field');
                                isValid = false;
                            } else {
                                element.classList.remove('error-field');
                            }
                        } else {
                            if (!element.value.trim()) {
                                element.classList.add('error-field');
                                isValid = false;
                            } else {
                                element.classList.remove('error-field');
                            }
                        }
                    }
                });
                
                const outerLayerChecked = document.getElementById('vikOuterLayer') ? document.getElementById('vikOuterLayer').checked : false;
                const innerLayerChecked = document.getElementById('vikInnerLayer') ? document.getElementById('vikInnerLayer').checked : false;
                const protectChecked = document.getElementById('vikProtect') ? document.getElementById('vikProtect').checked : false;
                
                if (outerLayerChecked) {
                    const outerMin = document.getElementById('outer-min' + suffix);
                    const outerMax = document.getElementById('outer-max' + suffix);
                    
                    if (outerMin && !outerMin.value.trim()) {
                        outerMin.classList.add('error-field');
                        isValid = false;
                    } else if (outerMin) {
                        outerMin.classList.remove('error-field');
                    }
                    
                    if (outerMax && !outerMax.value.trim()) {
                        outerMax.classList.add('error-field');
                        isValid = false;
                    } else if (outerMax) {
                        outerMax.classList.remove('error-field');
                    }
                }
                
                if (innerLayerChecked) {
                    const innerMin = document.getElementById('inner-min' + suffix);
                    const innerMax = document.getElementById('inner-max' + suffix);
                    
                    if (innerMin && !innerMin.value.trim()) {
                        innerMin.classList.add('error-field');
                        isValid = false;
                    } else if (innerMin) {
                        innerMin.classList.remove('error-field');
                    }
                    
                    if (innerMax && !innerMax.value.trim()) {
                        innerMax.classList.add('error-field');
                        isValid = false;
                    } else if (innerMax) {
                        innerMax.classList.remove('error-field');
                    }
                }
                
                if (protectChecked) {
                    const protectMin = document.getElementById('protect-min' + suffix);
                    const protectMax = document.getElementById('protect-max' + suffix);
                    
                    if (protectMin && !protectMin.value.trim()) {
                        protectMin.classList.add('error-field');
                        isValid = false;
                    } else if (protectMin) {
                        protectMin.classList.remove('error-field');
                    }
                    
                    if (protectMax && !protectMax.value.trim()) {
                        protectMax.classList.add('error-field');
                        isValid = false;
                    } else if (protectMax) {
                        protectMax.classList.remove('error-field');
                    }
                }
                
                return isValid;
            }

            vikCheckForDeviations(timeSlot) {
                const suffix = timeSlot === '8:00' ? '-1' : timeSlot === '12:00' ? '-2' : '-3';
                const deviations = [];
                
                // –ü–æ–ª—É—á–∞–µ–º –Ω–æ—Ä–º—ã
                const ovalNorm = parseFloat(document.getElementById('vikOvalMax').textContent);
                const wallMinNorm = parseFloat(document.getElementById('vikWallThicknessMin').textContent);
                const wallMaxNorm = parseFloat(document.getElementById('vikWallThicknessMax').textContent);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const ovalValue = parseFloat(document.getElementById('oval' + suffix).value);
                const wallMinValue = parseFloat(document.getElementById('wall-min' + suffix).value);
                const wallMaxValue = parseFloat(document.getElementById('wall-max' + suffix).value);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–≤–∞–ª—å–Ω–æ—Å—Ç—å (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –Ω–æ—Ä–º–µ)
                if (!isNaN(ovalNorm) && !isNaN(ovalValue)) {
                    if (ovalValue > ovalNorm) {
                        deviations.push({
                            parameter: '–û–≤–∞–ª—å–Ω–æ—Å—Ç—å',
                            value: ovalValue.toFixed(1) + ' –º–º',
                            norm: '‚â§ ' + ovalNorm.toFixed(1) + ' –º–º',
                            fieldId: 'oval' + suffix,
                            type: 'max'
                        });
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ç–æ–ª—â–∏–Ω—É —Å—Ç–µ–Ω–∫–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –Ω–æ—Ä–º–µ)
                if (!isNaN(wallMinNorm) && !isNaN(wallMinValue)) {
                    if (wallMinValue < wallMinNorm) {
                        deviations.push({
                            parameter: '–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ (min)',
                            value: wallMinValue.toFixed(2) + ' –º–º',
                            norm: '‚â• ' + wallMinNorm.toFixed(2) + ' –º–º',
                            fieldId: 'wall-min' + suffix,
                            type: 'min'
                        });
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ç–æ–ª—â–∏–Ω—É —Å—Ç–µ–Ω–∫–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –Ω–æ—Ä–º–µ)
                if (!isNaN(wallMaxNorm) && !isNaN(wallMaxValue)) {
                    if (wallMaxValue > wallMaxNorm) {
                        deviations.push({
                            parameter: '–¢–æ–ª—â–∏–Ω–∞ —Å—Ç–µ–Ω–∫–∏ (max)',
                            value: wallMaxValue.toFixed(2) + ' –º–º',
                            norm: '‚â§ ' + wallMaxNorm.toFixed(2) + ' –º–º',
                            fieldId: 'wall-max' + suffix,
                            type: 'max'
                        });
                    }
                }
                
                return deviations;
            }

            vikHighlightDeviationFields(timeSlot, deviations) {
                // –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∞–µ–º –≤—Å–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                this.vikClearDeviationHighlights();
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª—è —Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏
                deviations.forEach(deviation => {
                    const field = document.getElementById(deviation.fieldId);
                    if (field) {
                        field.classList.add('deviation-field');
                    }
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                if (deviations.length > 0) {
                    const warning = document.getElementById('vikDeviationWarning');
                    if (warning) {
                        warning.textContent = `–í–Ω–∏–º–∞–Ω–∏–µ! –í –∑–∞–º–µ—Ä–µ ${timeSlot} –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º (${deviations.length} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–µ –ø–æ–ª—è.`;
                        warning.style.display = 'block';
                    }
                }
            }

            vikClearDeviationHighlights() {
                // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –ø–æ–ª–µ–π
                const deviationFields = document.querySelectorAll('#vikFormContainer .deviation-field');
                deviationFields.forEach(field => {
                    field.classList.remove('deviation-field');
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                const warning = document.getElementById('vikDeviationWarning');
                if (warning) {
                    warning.style.display = 'none';
                }
            }

            vikShowDeviationModal(deviations) {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
                const deviationList = document.getElementById('deviationList');
                if (deviationList) {
                    deviationList.innerHTML = '';
                    
                    deviations.forEach(deviation => {
                        const item = document.createElement('div');
                        item.className = 'deviation-item';
                        
                        const paramSpan = document.createElement('span');
                        paramSpan.className = 'deviation-param';
                        paramSpan.textContent = deviation.parameter;
                        
                        const valuesSpan = document.createElement('span');
                        valuesSpan.className = 'deviation-values';
                        
                        const valueSpan = document.createElement('div');
                        valueSpan.className = 'deviation-value';
                        valueSpan.textContent = '–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ: ' + deviation.value;
                        
                        const normSpan = document.createElement('div');
                        normSpan.className = 'deviation-norm';
                        normSpan.textContent = '–ù–æ—Ä–º–∞: ' + deviation.norm;
                        
                        valuesSpan.appendChild(valueSpan);
                        valuesSpan.appendChild(normSpan);
                        
                        item.appendChild(paramSpan);
                        item.appendChild(valuesSpan);
                        
                        deviationList.appendChild(item);
                    });
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.getElementById('deviationModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            vikHideDeviationModal() {
                const modal = document.getElementById('deviationModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                this.vikClearDeviationHighlights();
            }

            async vikSendMeasurementsData(timeSlot) {
                const measurementData = this.vikCollectMeasurementData(timeSlot);
                const success = await this.vikSendDataToN8N(measurementData);
                
                if (success) {
                    this.vikShowSuccess(`–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ ${timeSlot} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!`);
                    this.submittedSlots.add(timeSlot);
                    this.slotData[timeSlot] = measurementData;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    await this.vikCheckProgress();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤
                    this.vikUpdateTimeSlotsAvailability();
                    
                    this.vikClearValidationErrors();
                } else {
                    this.vikShowError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
            }

            vikCollectMeasurementData(timeSlot) {
                const suffix = timeSlot === '8:00' ? '-1' : timeSlot === '12:00' ? '-2' : timeSlot === '16:00' ? '-3' : '';
                const outerLayerChecked = document.getElementById('vikOuterLayer') ? document.getElementById('vikOuterLayer').checked : false;
                const innerLayerChecked = document.getElementById('vikInnerLayer') ? document.getElementById('vikInnerLayer').checked : false;
                const protectChecked = document.getElementById('vikProtect') ? document.getElementById('vikProtect').checked : false;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –í–ò–ö
                const dateInput = document.getElementById('vikDate');
                const fioInput = document.getElementById('vikEmployee');
                const shiftHidden = document.getElementById('vikShiftHidden');
                const centerHidden = document.getElementById('vikCenterHidden');
                const batchHidden = document.getElementById('vikBatchHidden');
                const nomenclatureInput = document.getElementById('vikNomenclatureInput');
                
                if (!dateInput || !dateInput.value || !fioInput || !fioInput.value) {
                    this.vikShowError('–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã');
                    return null;
                }
                
                const fioValue = fioInput.value;
                
                let hash = 0;
                for (let i = 0; i < fioValue.length; i++) {
                    const char = fioValue.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                const stableEmployeeId = `emp_${Math.abs(hash)}`;
                
                const getValue = (id) => {
                    const element = document.getElementById(id);
                    return element ? (element.value || '') : '';
                };
                
                const getChecked = (id) => {
                    const element = document.getElementById(id);
                    return element ? element.checked : false;
                };
                
                const data = {
                    date: dateInput.value,
                    employeeId: stableEmployeeId,
                    fio: fioValue,
                    shift: shiftHidden ? shiftHidden.value : '',
                    center: centerHidden ? centerHidden.value : '',
                    batch: batchHidden ? batchHidden.value : '',
                    nomenclature: nomenclatureInput ? nomenclatureInput.value : '',
                    diameter: getValue('vikDiameterInput'),
                    sdr: getValue('vikSdrInput'),
                    length: getValue('vikLength'),
                    timeSlot: timeSlot,
                    pipeNumber: getValue('pipe-number' + suffix),
                    diameterMeasured: getValue('diameter' + suffix),
                    oval: getValue('oval' + suffix),
                    wallMin: getValue('wall-min' + suffix),
                    wallMax: getValue('wall-max' + suffix),
                    outerMin: outerLayerChecked ? getValue('outer-min' + suffix) : '',
                    outerMax: outerLayerChecked ? getValue('outer-max' + suffix) : '',
                    innerMin: innerLayerChecked ? getValue('inner-min' + suffix) : '',
                    innerMax: innerLayerChecked ? getValue('inner-max' + suffix) : '',
                    protectMin: protectChecked ? getValue('protect-min' + suffix) : '',
                    protectMax: protectChecked ? getValue('protect-max' + suffix) : '',
                    lengthMeasured: getValue('length' + suffix),
                    appearanceOuter: getValue('appearance-outer' + suffix),
                    appearanceInner: getValue('appearance-inner' + suffix),
                    ends: getValue('ends' + suffix),
                    marking: getValue('marking' + suffix),
                    markingDistance: getValue('marking-distance' + suffix),
                    plugs: getChecked('plugs' + suffix),
                    hasDeviations: this.pendingDeviations.length > 0,
                    deviations: this.pendingDeviations.length > 0 ? JSON.stringify(this.pendingDeviations) : ''
                };
                
                return data;
            }

            async vikSendDataToN8N(data) {
                try {
                    this.vikShowInfo('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                    
                    const response = await fetch(this.N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.vikShowSuccess('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                        return true;
                    } else {
                        throw new Error(result.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                    
                } catch (error) {
                    this.vikShowError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
                    return false;
                }
            }

            vikClearValidationErrors() {
                const errorFields = document.querySelectorAll('#vikFormContainer .error-field');
                errorFields.forEach(el => {
                    el.classList.remove('error-field');
                });
            }

            vikResetFormState() {
                this.submittedSlots = new Set();
                this.slotData = {};
                const progressIndicator = document.getElementById('vikProgressIndicator');
                if (progressIndicator) progressIndicator.style.display = 'none';
                this.vikInitializeMeasurementState();
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –í–ò–ö
            vikShowSuccess(message) {
                const element = document.getElementById('vikSuccessMessage');
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                    setTimeout(() => element.style.display = 'none', 3000);
                }
            }

            vikShowError(message) {
                const element = document.getElementById('vikErrorMessage');
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                    setTimeout(() => element.style.display = 'none', 5000);
                }
            }

            vikShowInfo(message) {
                const element = document.getElementById('vikInfoMessage');
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                }
            }

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º –∏ —Ñ–æ—Ä–º—É–ª
            async loadNormsFromWebhook() {
                try {
                    const response = await fetch(this.NORMS_WEBHOOK_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && Array.isArray(result.data)) {
                        this.normsData = result.data;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:', error);
                }
            }

            async loadFormulasFromWebhook() {
                try {
                    const response = await fetch('https://tunnel.itrz.ru/webhook/get-formulas');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.formulas) {
                            this.calculationFormulas = result.formulas;
                        }
                    }
                } catch (error) {
                    console.log('–§–æ—Ä–º—É–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ');
                }
            }

            // =============== –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º—ã –û–ø–µ—Ä ===============
            validateInlineWasteField(field) {
                const value = parseFloat(field.value);
                const row = field.closest('.waste-types-container');
                
                if (isNaN(value) || value < 0) {
                    field.classList.add('validation-error');
                    return false;
                } else {
                    field.classList.remove('validation-error');
                    field.classList.add('validation-success');
                    return true;
                }
            }

            clearInlineWasteError(field) {
                field.classList.remove('validation-error');
            }

            addWasteTypeChangeHandlers() {
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('vidyOthodovSelect')) {
                        this.handleWasteTypeChange(e.target);
                    }
                });
            }

            handleWasteTypeChange(selectElement) {
                const wasteType = selectElement.value;
                const reasonSelect = selectElement.closest('.waste-types-container').querySelector('.prichinaOthodovSelect');
                
                if (!reasonSelect) return;
                
                if (wasteType === '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ') {
                    reasonSelect.innerHTML = '<option value="---------">---------</option>';
                    reasonSelect.value = '---------';
                } else if (wasteType === '–ê–≤–∞—Ä–∏–π–Ω—ã–µ') {
                    reasonSelect.innerHTML = '<option value="–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —ç/—ç–Ω–µ—Ä–≥–∏–∏">–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —ç/—ç–Ω–µ—Ä–≥–∏–∏</option>';
                    reasonSelect.value = '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —ç/—ç–Ω–µ—Ä–≥–∏–∏';
                } else {
                    this.populateWasteSelect(reasonSelect);
                }
            }

            handleNoDowntimeChange(isChecked) {
                const downtimeContainer = document.getElementById('downtime-container');
                const addDowntimeBtn = document.getElementById('add-downtime-btn');
                
                if (isChecked) {
                    downtimeContainer.classList.add('disabled-section');
                    addDowntimeBtn.classList.add('disabled-section');
                    
                    const downtimeRows = downtimeContainer.querySelectorAll('.downtime-row');
                    downtimeRows.forEach(row => {
                        const reasonSelect = row.querySelector('.prichinaProstoya');
                        const hoursInput = row.querySelector('.downtime-hours');
                        const minutesInput = row.querySelector('.downtime-minutes');
                        if (reasonSelect) reasonSelect.value = '';
                        if (hoursInput) hoursInput.value = '';
                        if (minutesInput) minutesInput.value = '';
                    });
                } else {
                    downtimeContainer.classList.remove('disabled-section');
                    addDowntimeBtn.classList.remove('disabled-section');
                }
            }

            addTimeConversionHandlers() {
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('downtime-hours')) {
                        this.validateHours(e.target);
                    }
                    if (e.target.classList.contains('downtime-minutes')) {
                        this.validateMinutes(e.target);
                    }
                });
            }

            validateHours(input) {
                const value = parseInt(input.value);
                if (isNaN(value) || value < 0) {
                    input.value = '';
                } else if (value > 24) {
                    input.value = 24;
                }
            }

            validateMinutes(input) {
                const value = parseInt(input.value);
                if (isNaN(value) || value < 0) {
                    input.value = '';
                } else if (value > 59) {
                    input.value = 59;
                }
            }

            formatTotalDowntime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}—á. ${mins}–º–∏–Ω.`;
            }

            getFormattedDowntime() {
                const noDowntimeChecked = document.getElementById('noDowntimeCheckbox').checked;
                
                if (noDowntimeChecked) {
                    return {
                        reasons: '–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è',
                        times: '0',
                        totalMinutes: 0,
                        totalTimeFormatted: '0—á. 0–º–∏–Ω.',
                        reasonsArray: ['–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è'],
                        timesArray: ['0']
                    };
                }

                const downtimeRows = document.querySelectorAll('.downtime-row');
                const reasons = [];
                const times = [];
                let totalMinutes = 0;
                
                for (let i = 0; i < downtimeRows.length; i++) {
                    const reasonSelect = downtimeRows[i].querySelector('.prichinaProstoya');
                    const hoursInput = downtimeRows[i].querySelector('.downtime-hours');
                    const minutesInput = downtimeRows[i].querySelector('.downtime-minutes');
                    
                    if (reasonSelect.value && hoursInput.value && minutesInput.value) {
                        reasons.push(reasonSelect.value);
                        
                        const hours = parseInt(hoursInput.value) || 0;
                        const minutes = parseInt(minutesInput.value) || 0;
                        const totalTimeMinutes = hours * 60 + minutes;
                        
                        const formattedTime = `${hours}.${minutes.toString().padStart(2, '0')}`;
                        times.push(formattedTime);
                        
                        totalMinutes += totalTimeMinutes;
                    }
                }
                
                return {
                    reasons: reasons.join('; '),
                    times: times.join('; '),
                    totalMinutes: totalMinutes,
                    totalTimeFormatted: this.formatTotalDowntime(totalMinutes),
                    reasonsArray: reasons,
                    timesArray: times
                };
            }

            getFormattedWasteData() {
                const wasteRows = document.querySelectorAll('.waste-types-container');
                const wasteTypes = [];
                const wasteReasons = [];
                const wasteWeights = [];
                
                for (let i = 0; i < wasteRows.length; i++) {
                    const typeSelect = wasteRows[i].querySelector('.vidyOthodovSelect');
                    const reasonSelect = wasteRows[i].querySelector('.prichinaOthodovSelect');
                    const weightInput = wasteRows[i].querySelector('.vesOthodovInline');
                    
                    if (typeSelect.value && reasonSelect.value && weightInput && weightInput.value) {
                        wasteTypes.push(typeSelect.value);
                        wasteReasons.push(reasonSelect.value);
                        wasteWeights.push(parseFloat(weightInput.value) || 0);
                    }
                }
                
                return {
                    wasteTypes: wasteTypes.join('; '),
                    wasteReasons: wasteReasons.join('; '),
                    wasteWeights: wasteWeights.join('; '),
                    wasteTypesArray: wasteTypes,
                    wasteReasonsArray: wasteReasons,
                    wasteWeightsArray: wasteWeights
                };
            }

            getFormattedObrazcy() {
                const kolichestvo = document.getElementById('obrazcyKolichestvo').value || '0';
                const metrazh = document.getElementById('obrazcyMetrazh').value || '0';
                return `${kolichestvo} x ${metrazh}`;
            }

            addWasteRow() {
                const wasteContainer = document.getElementById('waste-container');
                const newRow = document.createElement('div');
                newRow.className = 'waste-types-container';
                
                newRow.innerHTML = `
                    <div>
                        <label>–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                        <select class="vidyOthodovSelect" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ --</option>
                            <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ</option>
                            <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                            <option value="–ê–≤–∞—Ä–∏–π–Ω—ã–µ">–ê–≤–∞—Ä–∏–π–Ω—ã–µ</option>
                        </select>
                    </div>
                    <div>
                        <label>–ü—Ä–∏—á–∏–Ω—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                        <select class="prichinaOthodovSelect" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                        </select>
                    </div>
                    <div>
                        <label>–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤ (–∫–≥)</label>
                        <input type="number" class="vesOthodovInline" step="0.01" placeholder="–í–µ—Å" min="0" required>
                    </div>
                    <button type="button" class="remove-waste-btn-inline">√ó</button>
                `;
                
                wasteContainer.appendChild(newRow);
                
                const reasonSelect = newRow.querySelector('.prichinaOthodovSelect');
                this.populateWasteSelect(reasonSelect);
                
                const typeSelect = newRow.querySelector('.vidyOthodovSelect');
                typeSelect.addEventListener('change', (e) => this.handleWasteTypeChange(e.target));
                
                const weightInput = newRow.querySelector('.vesOthodovInline');
                weightInput.addEventListener('blur', () => this.validateInlineWasteField(weightInput));
                weightInput.addEventListener('input', () => this.clearInlineWasteError(weightInput));
                
                // –î–æ–±–∞–≤–ª–µ–Ω–æ: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –≤–µ—Å–∞
                weightInput.addEventListener('input', () => this.validateWasteWeightAgainstLimit(weightInput));
                
                newRow.querySelector('.remove-waste-btn-inline').addEventListener('click', function() {
                    wasteContainer.removeChild(newRow);
                });
            }

            handleMarkirovkaChange(value) {
                const select = document.getElementById('proverkaMarkirovki');
                select.classList.remove('markirovka-not-checked', 'markirovka-checked');
                
                if (value === '–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ') {
                    select.classList.add('markirovka-checked');
                } else {
                    select.classList.add('markirovka-not-checked');
                }
            }

            addDowntimeRow() {
                const downtimeContainer = document.getElementById('downtime-container');
                const newRow = document.createElement('div');
                newRow.className = 'downtime-row';
                
                newRow.innerHTML = `
                    <div class="downtime-container">
                        <div>
                            <label>–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è</label>
                            <select class="prichinaProstoya" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                            </select>
                        </div>
                        <div>
                            <label>–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è</label>
                            <div class="time-input-container">
                                <div class="time-input-wrapper">
                                    <input type="number" class="downtime-hours" placeholder="–ß–∞—Å—ã" min="0" max="24" required>
                                </div>
                                <div class="time-separator">:</div>
                                <div class="time-input-wrapper">
                                    <input type="number" class="downtime-minutes" placeholder="–ú–∏–Ω—É—Ç—ã" min="0" max="59" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="remove-downtime-btn">√ó</button>
                `;
                
                downtimeContainer.appendChild(newRow);
                
                const select = newRow.querySelector('.prichinaProstoya');
                this.populateDowntimeSelect(select);
                
                newRow.querySelector('.remove-downtime-btn').addEventListener('click', function() {
                    downtimeContainer.removeChild(newRow);
                });
            }

            addValidationHandlers() {
                const requiredFields = [
                    'proizvoditelnostFact', 
                    'proverkaMarkirovki', 
                    'nomerOtrezka', 
                    'kolichestvoGP', 
                    'vesGP', 
                    'vvodRegranulata'
                ];
                
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field) return;
                    field.addEventListener('blur', () => this.validateField(fieldId));
                    field.addEventListener('input', () => this.clearFieldError(fieldId));
                });
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–∑—Ü–æ–≤
                const obrazcyKolichestvo = document.getElementById('obrazcyKolichestvo');
                const obrazcyMetrazh = document.getElementById('obrazcyMetrazh');
                const obrazcyError = document.getElementById('obrazcyError');
                
                if (obrazcyKolichestvo) {
                    obrazcyKolichestvo.addEventListener('blur', () => this.validateObrazcy());
                    obrazcyKolichestvo.addEventListener('input', () => {
                        obrazcyKolichestvo.classList.remove('validation-error');
                        if (obrazcyError) obrazcyError.style.display = 'none';
                    });
                }
                
                if (obrazcyMetrazh) {
                    obrazcyMetrazh.addEventListener('blur', () => this.validateObrazcy());
                    obrazcyMetrazh.addEventListener('input', () => {
                        obrazcyMetrazh.classList.remove('validation-error');
                        if (obrazcyError) obrazcyError.style.display = 'none';
                    });
                }
            }

            validateObrazcy() {
                const kolichestvo = document.getElementById('obrazcyKolichestvo');
                const metrazh = document.getElementById('obrazcyMetrazh');
                const errorElement = document.getElementById('obrazcyError');
                
                if (!kolichestvo || !metrazh) return true;
                
                const kolichestvoValue = String(kolichestvo.value).trim();
                const metrazhValue = String(metrazh.value).trim();
                
                if (kolichestvoValue === '' || metrazhValue === '') {
                    kolichestvo.classList.add('validation-error');
                    metrazh.classList.add('validation-error');
                    if (errorElement) errorElement.style.display = 'block';
                    return false;
                } else {
                    kolichestvo.classList.remove('validation-error');
                    metrazh.classList.remove('validation-error');
                    kolichestvo.classList.add('validation-success');
                    metrazh.classList.add('validation-success');
                    if (errorElement) errorElement.style.display = 'none';
                    return true;
                }
            }

            validateField(fieldId) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(fieldId + 'Error');
                if (!field) return true;
                
                let isValid = true;
                if (field.type === 'select-one') {
                    isValid = field.value !== '';
                } else {
                    isValid = String(field.value).trim() !== '';
                }
                
                if (!isValid) {
                    field.classList.add('validation-error');
                    if (errorElement) errorElement.style.display = 'block';
                    return false;
                } else {
                    field.classList.remove('validation-error');
                    field.classList.add('validation-success');
                    if (errorElement) errorElement.style.display = 'none';
                    return true;
                }
            }

            clearFieldError(fieldId) {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(fieldId + 'Error');
                if (!field) return;
                field.classList.remove('validation-error');
                if (errorElement) errorElement.style.display = 'none';
            }

            validateAllFields() {
                const fields = [
                    'proizvoditelnostFact', 
                    'proverkaMarkirovki', 
                    'nomerOtrezka', 
                    'kolichestvoGP', 
                    'vesGP', 
                    'vvodRegranulata'
                ];
                
                let isValid = true;
                fields.forEach(f => { if (!this.validateField(f)) isValid = false; });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞–∑—Ü—ã
                if (!this.validateObrazcy()) {
                    isValid = false;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥—ã, –ø—Ä–∏—á–∏–Ω—ã –∏ –≤–µ—Å –æ—Ç—Ö–æ–¥–æ–≤
                const wasteRows = document.querySelectorAll('.waste-types-container');
                if (wasteRows.length === 0) {
                    this.showMessage('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –æ—Ç—Ö–æ–¥–æ–≤', 'error');
                    document.getElementById('wasteError').style.display = 'block';
                    return false;
                }
                
                let hasWasteData = false;
                let allWasteFieldsValid = true;
                
                for (let i = 0; i < wasteRows.length; i++) {
                    const typeSelect = wasteRows[i].querySelector('.vidyOthodovSelect');
                    const reasonSelect = wasteRows[i].querySelector('.prichinaOthodovSelect');
                    const weightInput = wasteRows[i].querySelector('.vesOthodovInline');
                    
                    if (typeSelect && reasonSelect && weightInput) {
                        const typeValid = typeSelect.value !== '';
                        const reasonValid = reasonSelect.value !== '' && reasonSelect.value !== '---------';
                        const weightValid = weightInput.value !== '' && parseFloat(weightInput.value) >= 0;
                        
                        if (!typeValid) {
                            typeSelect.classList.add('validation-error');
                            allWasteFieldsValid = false;
                        } else {
                            typeSelect.classList.remove('validation-error');
                        }
                        
                        if (!reasonValid) {
                            reasonSelect.classList.add('validation-error');
                            allWasteFieldsValid = false;
                        } else {
                            reasonSelect.classList.remove('validation-error');
                        }
                        
                        if (!weightValid) {
                            weightInput.classList.add('validation-error');
                            allWasteFieldsValid = false;
                        } else {
                            weightInput.classList.remove('validation-error');
                        }
                        
                        if (typeValid && reasonValid && weightValid) {
                            hasWasteData = true;
                        }
                    }
                }
                
                if (!allWasteFieldsValid) {
                    this.showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –≤ —Å—Ç—Ä–æ–∫–∞—Ö –æ—Ç—Ö–æ–¥–æ–≤', 'error');
                    document.getElementById('wasteError').style.display = 'block';
                    return false;
                }
                
                if (!hasWasteData) {
                    this.showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –æ—Ç—Ö–æ–¥–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é', 'error');
                    document.getElementById('wasteError').style.display = 'block';
                    return false;
                }
                
                document.getElementById('wasteError').style.display = 'none';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ç–æ–π
                const noDowntimeChecked = document.getElementById('noDowntimeCheckbox').checked;
                
                if (!noDowntimeChecked) {
                    const downtimeRows = document.querySelectorAll('.downtime-row');
                    if (downtimeRows.length === 0) {
                        this.showMessage('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ—Å—Ç–æ—è –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è"', 'error');
                        return false;
                    }
                    
                    let hasDowntimeReason = false;
                    for (let i = 0; i < downtimeRows.length; i++) {
                        const reasonSelect = downtimeRows[i].querySelector('.prichinaProstoya');
                        const hoursInput = downtimeRows[i].querySelector('.downtime-hours');
                        const minutesInput = downtimeRows[i].querySelector('.downtime-minutes');
                        
                        if (reasonSelect.value && hoursInput.value && minutesInput.value) {
                            hasDowntimeReason = true;
                            
                            const hours = parseInt(hoursInput.value);
                            const minutes = parseInt(minutesInput.value);
                            
                            if (isNaN(hours) || hours < 0 || hours > 24) {
                                this.showMessage(`–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Å–æ–≤ –≤ –±–ª–æ–∫–µ ${i+1}. –î–æ–ø—É—Å—Ç–∏–º–æ –æ—Ç 0 –¥–æ 24.`, 'error');
                                hoursInput.focus();
                                return false;
                            }
                            
                            if (isNaN(minutes) || minutes < 0 || minutes > 59) {
                                this.showMessage(`–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç –≤ –±–ª–æ–∫–µ ${i+1}. –î–æ–ø—É—Å—Ç–∏–º–æ –æ—Ç 0 –¥–æ 59.`, 'error');
                                minutesInput.focus();
                                return false;
                            }
                        }
                    }
                    
                    if (!hasDowntimeReason) {
                        this.showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø—Ä–∏—á–∏–Ω—É –∏ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è"', 'error');
                        return false;
                    }
                }
                
                return isValid;
            }

            showMessage(text, type) {
                const msg = document.getElementById('message');
                msg.textContent = text;
                msg.className = type;
                if (type !== 'loading') setTimeout(() => { msg.textContent=''; msg.className=''; }, 5000);
            }

            showLoading(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') { this.showMessage(text, 'loading'); }
            hideLoading() { const msg = document.getElementById('message'); if (msg.classList.contains('loading')) { msg.textContent=''; msg.className=''; } }

            async loadSpravkaData() {
                try {
                    const response = await fetch(this.spravkaUrl);
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    const result = await response.json();
                    
                    if (result.success && Array.isArray(result.data)) {
                        const wasteReasons = [...new Set(result.data.map(item => item['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Ö–æ–¥–æ–≤']).filter(Boolean))];
                        const downtimeReasons = [...new Set(result.data.map(item => item['–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è']).filter(Boolean))];
                        
                        this.wasteReasons = wasteReasons;
                        this.downtimeReasons = downtimeReasons;
                        
                        this.populateWasteSelect();
                        this.populateMainDowntimeSelect();
                    } else {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ', e);
                    this.wasteReasons = [
                        '–ë—Ä–∞–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞',
                        '–û—Å—Ç–∞—Ç–∫–∏ —Å—ã—Ä—å—è',
                        '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—Ç—Ö–æ–¥—ã',
                        '–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞',
                        '–î—Ä—É–≥–æ–µ'
                    ];
                    this.downtimeReasons = [
                        '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ',
                        '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—ã—Ä—å—è',
                        '–ü–æ–ª–æ–º–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è',
                        '–ü–µ—Ä–µ–Ω–∞–ª–∞–¥–∫–∞ –ª–∏–Ω–∏–∏',
                        '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞',
                        '–ü–ª–∞–Ω–æ–≤—ã–π —Ä–µ–º–æ–Ω—Ç'
                    ];
                    this.populateWasteSelect();
                    this.populateMainDowntimeSelect();
                }
            }

            async loadDataByDate(date) {
                if (!date) return;
                this.showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                this.hideEmployeeData();
                this.hideEmployeeInput();
                this.hideEmployeeSelect();

                try {
                    const response = await fetch(`${this.n8nWebhookUrl}?date=${encodeURIComponent(date)}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const result = await response.json();
                    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);

                    if (result.success && Array.isArray(result.allData) && result.allData.length > 0) {
                        this.allData = result.allData;
                        this.employees = Array.isArray(result.employees) ? result.employees : [];
                        
                        this.populateEmployeeSelect();
                        this.showMessage(`–ù–∞–π–¥–µ–Ω–æ ${this.employees.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`, 'success');
                    } else {
                        this.allData = [];
                        this.employees = [];
                        this.showMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É', 'info');
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                    this.showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            populateEmployeeSelect() {
                const select = document.getElementById('employeeSelect');
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>';
                
                if (this.employees.length === 0) {
                    document.getElementById('employeeGroup').style.display = 'none';
                    return;
                }
                
                const fioCount = {};
                const fioEntries = {};
                
                this.employees.forEach(emp => {
                    if (emp.label) {
                        const cleanFio = emp.label.replace(/\s*\(–ó–∞–ø–∏—Å—å\s*\d+\)\s*$/, '').trim();
                        
                        if (cleanFio) {
                            fioCount[cleanFio] = (fioCount[cleanFio] || 0) + 1;
                            if (!fioEntries[cleanFio]) fioEntries[cleanFio] = [];
                            fioEntries[cleanFio].push(emp.index);
                        }
                    }
                });
                
                const usedFios = new Set();
                
                this.employees.forEach(emp => {
                    if (emp.label) {
                        const cleanFio = emp.label.replace(/\s*\(–ó–∞–ø–∏—Å—å\s*\d+\)\s*$/, '').trim();
                        
                        if (cleanFio && !usedFios.has(`${cleanFio}_${emp.index}`)) {
                            const option = document.createElement('option');
                            option.value = emp.index;
                            
                            let label = cleanFio;
                            if (fioCount[cleanFio] > 1) {
                                const entries = fioEntries[cleanFio];
                                const taskNumber = entries.indexOf(emp.index) + 1;
                                label += ` (–ó–∞–¥–∞–Ω–∏–µ ${taskNumber})`;
                            }
                            
                            option.textContent = label;
                            select.appendChild(option);
                            usedFios.add(`${cleanFio}_${emp.index}`);
                        }
                    }
                });
                
                document.getElementById('employeeGroup').style.display = 'block';
            }

            displayEmployeeData(index) {
                if (index === "" || !this.allData.length) {
                    this.hideEmployeeInput();
                    return;
                }
                
                const emp = this.allData.find(e => String(e.index) === String(index));
                if (!emp) {
                    this.showMessage('–î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                    return;
                }

                this.currentEmployee = emp;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                document.getElementById('fioView').value = emp['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'] || '';
                document.getElementById('fio2View').value = emp['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'] || '';
                document.getElementById('smenaView').value = emp['–°–º–µ–Ω–∞'] || '';
                document.getElementById('denbView').value = emp['–î–µ–Ω—å_–ù–æ—á—å'] || '';
                document.getElementById('proizView').value = emp['–í–∏–¥ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞'] || '';
                document.getElementById('centerView').value = emp['–†–∞–±–æ—á–∏–π —Ü–µ–Ω—Ç—Ä'] || '';
                document.getElementById('commentView').value = emp['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞'] || '';
                document.getElementById('nomenklaturaView').value = emp['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] || '';
                document.getElementById('partiyaView').value = emp['–ü–∞—Ä—Ç–∏—è'] || '';
                document.getElementById('vesPogMetraView').value = emp['–í–µ—Å –ø–æ–≥. –º–µ—Ç—Ä–∞ (–∫–≥)'] || '';
                document.getElementById('ostatokView').value = emp['–û—Å—Ç–∞—Ç–æ–∫ –ø–æ –ø–ª–∞–Ω—É'] || '';
                
                document.getElementById('harakteristikiView').value = emp['–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏'] || '';
                
                document.getElementById('markaPEView').value = emp['–ú–∞—Ä–∫–∞ –ü–≠ –≤ –ì–ü'] || '';
                document.getElementById('proizvoditelnostView').value = emp['–¢–µ—Ö–Ω. –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'] || '';
                document.getElementById('markirovkaView').value = emp['–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä—É–±—ã'] || '';
                
                const znakImageValue = emp['–ó–Ω–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'] || '';
                document.getElementById('znakImageView').value = znakImageValue;
                this.handleImageDisplay(znakImageValue);
                
                document.getElementById('obrazcyShtView').value = emp['–û–±—Ä–∞–∑—Ü—ã —à—Ç.'] || '';
                document.getElementById('obrazcyMetrView').value = emp['–û–±—Ä–∞–∑—Ü—ã –º–µ—Ç—Ä.'] || '';
                
                document.getElementById('markaRegranulataView').value = emp['–ú–∞—Ä–∫–∞ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞'] || '';
                document.getElementById('kolvoRegranulataView').value = emp['–ö–æ–ª-–≤–æ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞ %'] || '';
                document.getElementById('normaVremeniView').value = emp['–ù–æ—Ä–º–∞ –≤—Ä. –Ω–∞ –ø–µ—Ä–µ–Ω–∞–ª–∞–¥–∫—É'] || '';

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                document.getElementById('proizvoditelnostFact').value = emp['–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç'] || '';
                document.getElementById('proverkaMarkirovki').value = emp['–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏'] || '–ù–ï –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ';
                this.handleMarkirovkaChange(document.getElementById('proverkaMarkirovki').value);
                document.getElementById('nomerOtrezka').value = emp['–ù–æ–º–µ—Ä –æ—Ç—Ä–µ–∑–∫–∞/–±—É—Ö—Ç—ã'] || '';
                document.getElementById('kolichestvoGP').value = emp['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω–æ–π –ì–ü'] || '';
                document.getElementById('vesGP').value = emp['–í–µ—Å –ì–ü'] || '';
                document.getElementById('vvodRegranulata').value = emp['–í–≤–æ–¥ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞ –ö–ì.'] || '';

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –æ–±—Ä–∞–∑—Ü–æ–≤
                if (emp['–û–±—Ä–∞–∑—Ü—ã_–Ω–æ–≤—ã–µ']) {
                    const obrazcyParts = emp['–û–±—Ä–∞–∑—Ü—ã_–Ω–æ–≤—ã–µ'].split(' x ');
                    if (obrazcyParts.length === 2) {
                        document.getElementById('obrazcyKolichestvo').value = obrazcyParts[0].trim();
                        document.getElementById('obrazcyMetrazh').value = obrazcyParts[1].trim();
                    }
                }

                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–æ–≤, –ø—Ä–∏—á–∏–Ω –∏ –≤–µ—Å–∞ –æ—Ç—Ö–æ–¥–æ–≤
                const wasteContainer = document.getElementById('waste-container');
                wasteContainer.innerHTML = '';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—Ö–æ–¥–æ–≤ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
                if (emp['–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤'] && emp['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Ö–æ–¥–æ–≤'] && emp['–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤']) {
                    const types = emp['–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤'].split(';').map(t => t.trim());
                    const reasons = emp['–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Ö–æ–¥–æ–≤'].split(';').map(r => r.trim());
                    const weights = emp['–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤'].split(';').map(w => w.trim());
                    
                    for (let i = 0; i < Math.max(types.length, reasons.length, weights.length); i++) {
                        if (types[i] || reasons[i] || weights[i]) {
                            const newRow = document.createElement('div');
                            newRow.className = 'waste-types-container';
                            
                            if (i === 0) {
                                newRow.innerHTML = `
                                    <div>
                                        <label>–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                                        <select class="vidyOthodovSelect" required>
                                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ --</option>
                                            <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ</option>
                                            <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                                            <option value="–ê–≤–∞—Ä–∏–π–Ω—ã–µ">–ê–≤–∞—Ä–∏–π–Ω—ã–µ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>–ü—Ä–∏—á–∏–Ω—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                                        <select class="prichinaOthodovSelect" required>
                                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤ (–∫–≥)</label>
                                        <input type="number" class="vesOthodovInline" step="0.01" placeholder="–í–µ—Å" min="0" required>
                                    </div>
                                    <div class="add-waste-btn-inline" id="add-waste-btn-inline">+</div>
                                `;
                            } else {
                                newRow.innerHTML = `
                                    <div>
                                        <label>–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                                        <select class="vidyOthodovSelect" required>
                                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ --</option>
                                            <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ</option>
                                            <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                                            <option value="–ê–≤–∞—Ä–∏–π–Ω—ã–µ">–ê–≤–∞—Ä–∏–π–Ω—ã–µ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>–ü—Ä–∏—á–∏–Ω—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                                        <select class="prichinaOthodovSelect" required>
                                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤ (–∫–≥)</label>
                                        <input type="number" class="vesOthodovInline" step="0.01" placeholder="–í–µ—Å" min="0" required>
                                    </div>
                                    <button type="button" class="remove-waste-btn-inline">√ó</button>
                                `;
                            }
                            
                            wasteContainer.appendChild(newRow);
                            
                            const typeSelect = newRow.querySelector('.vidyOthodovSelect');
                            const reasonSelect = newRow.querySelector('.prichinaOthodovSelect');
                            const weightInput = newRow.querySelector('.vesOthodovInline');
                            
                            typeSelect.value = types[i] || '';
                            this.handleWasteTypeChange(typeSelect);
                            
                            if (!reasonSelect.value && reasons[i]) {
                                reasonSelect.value = reasons[i];
                            }
                            
                            weightInput.value = weights[i] || '';
                            
                            if (i > 0) {
                                newRow.querySelector('.remove-waste-btn-inline').addEventListener('click', function() {
                                    wasteContainer.removeChild(newRow);
                                });
                            }
                            
                            typeSelect.addEventListener('change', (e) => this.handleWasteTypeChange(e.target));
                            weightInput.addEventListener('blur', () => this.validateInlineWasteField(weightInput));
                            weightInput.addEventListener('input', () => this.clearInlineWasteError(weightInput));
                            // –î–æ–±–∞–≤–ª–µ–Ω–æ: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—è –≤–µ—Å–∞
                            weightInput.addEventListener('input', () => this.validateWasteWeightAgainstLimit(weightInput));
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
                if (wasteContainer.children.length === 0) {
                    const newRow = document.createElement('div');
                    newRow.className = 'waste-types-container';
                    newRow.innerHTML = `
                        <div>
                            <label>–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                            <select class="vidyOthodovSelect" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ --</option>
                                <option value="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ</option>
                                <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                                <option value="–ê–≤–∞—Ä–∏–π–Ω—ã–µ">–ê–≤–∞—Ä–∏–π–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div>
                            <label>–ü—Ä–∏—á–∏–Ω—ã –æ—Ç—Ö–æ–¥–æ–≤</label>
                            <select class="prichinaOthodovSelect" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                            </select>
                        </div>
                        <div>
                            <label>–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤ (–∫–≥)</label>
                            <input type="number" class="vesOthodovInline" step="0.01" placeholder="–í–µ—Å" min="0" required>
                        </div>
                        <div class="add-waste-btn-inline" id="add-waste-btn-inline">+</div>
                    `;
                    wasteContainer.appendChild(newRow);
                    
                    const reasonSelect = newRow.querySelector('.prichinaOthodovSelect');
                    this.populateWasteSelect(reasonSelect);
                    
                    const typeSelect = newRow.querySelector('.vidyOthodovSelect');
                    typeSelect.addEventListener('change', (e) => this.handleWasteTypeChange(e.target));
                    
                    const weightInput = newRow.querySelector('.vesOthodovInline');
                    weightInput.addEventListener('blur', () => this.validateInlineWasteField(weightInput));
                    weightInput.addEventListener('input', () => this.clearInlineWasteError(weightInput));
                    // –î–æ–±–∞–≤–ª–µ–Ω–æ: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –≤–µ—Å–∞
                    weightInput.addEventListener('input', () => this.validateWasteWeightAgainstLimit(weightInput));
                }

                const addWasteBtn = document.getElementById('add-waste-btn-inline');
                if (addWasteBtn) {
                    addWasteBtn.addEventListener('click', () => this.addWasteRow());
                }

                const noDowntimeCheckbox = document.getElementById('noDowntimeCheckbox');
                const downtimeContainer = document.getElementById('downtime-container');
                downtimeContainer.innerHTML = '';
                
                if (emp['–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è'] && emp['–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è']) {
                    const reasons = emp['–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è'].split(';').map(r => r.trim());
                    const times = emp['–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è'].split(';').map(t => t.trim());
                    
                    if (reasons[0] === '–ù–µ—Ç –ø—Ä–æ—Å—Ç–æ—è') {
                        noDowntimeCheckbox.checked = true;
                        this.handleNoDowntimeChange(true);
                    } else {
                        noDowntimeCheckbox.checked = false;
                        this.handleNoDowntimeChange(false);
                        
                        for (let i = 0; i < reasons.length; i++) {
                            if (reasons[i] && times[i]) {
                                const newRow = document.createElement('div');
                                newRow.className = 'downtime-row';
                                newRow.innerHTML = `
                                    <div class="downtime-container">
                                        <div>
                                            <label>–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è</label>
                                            <select class="prichinaProstoya" required>
                                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è</label>
                                            <div class="time-input-container">
                                                <div class="time-input-wrapper">
                                                    <input type="number" class="downtime-hours" placeholder="–ß–∞—Å—ã" min="0" max="24" required>
                                                </div>
                                                <div class="time-separator">:</div>
                                                <div class="time-input-wrapper">
                                                    <input type="number" class="downtime-minutes" placeholder="–ú–∏–Ω—É—Ç—ã" min="0" max="59" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="remove-downtime-btn">√ó</button>
                                `;
                                downtimeContainer.appendChild(newRow);
                                
                                const select = newRow.querySelector('.prichinaProstoya');
                                this.populateDowntimeSelect(select);
                                select.value = reasons[i] || '';
                                
                                const timeParts = times[i].split('.');
                                const hours = timeParts[0] || '0';
                                const minutes = timeParts[1] || '0';
                                
                                const hoursInput = newRow.querySelector('.downtime-hours');
                                const minutesInput = newRow.querySelector('.downtime-minutes');
                                hoursInput.value = hours;
                                minutesInput.value = minutes;
                                
                                newRow.querySelector('.remove-downtime-btn').addEventListener('click', function() {
                                    downtimeContainer.removeChild(newRow);
                                });
                            }
                        }
                    }
                } else {
                    noDowntimeCheckbox.checked = false;
                    this.handleNoDowntimeChange(false);
                    this.addDowntimeRow();
                }

                this.showEmployeeData();
                this.showEmployeeInput();
                this.clearAllValidationErrors();
                
                const employeeName = emp['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞'] || emp['–§–ò–û –º–∞—à–∏–Ω–∏—Å—Ç–∞ 2'] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫';
                this.showMessage(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è: ${employeeName}`, 'success');
                
                // –î–æ–±–∞–≤–ª–µ–Ω–æ: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                this.checkProductivityDeviation();
            }

            handleImageDisplay(znakValue) {
                const preview = document.getElementById('znakImagePreview');
                preview.style.display = 'none';
                
                if (!znakValue || znakValue.trim() === '' || znakValue === '–ë–µ–∑ –∑–Ω–∞–∫–∞') {
                    return;
                }
                
                if (znakValue.startsWith('data:image/')) {
                    preview.style.display = 'block';
                    preview.src = znakValue;
                    return;
                }
                
                let imageSrc = '';
                const normalizedValue = znakValue.toLowerCase().trim();
                
                if (normalizedValue.includes('–æ–±–∞') || normalizedValue.includes('–æ–±–∞ –ø—Ä–∏–∑–Ω–∞–∫–∞')) {
                    imageSrc = this.images['–û–±–∞ –ø—Ä–∏–∑–Ω–∞–∫–∞'];
                } else if (normalizedValue.includes('–º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç–∏') || normalizedValue.includes('–º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å')) {
                    imageSrc = this.images['–ó–Ω–∞–∫ –ú–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç–∏'];
                } else if (normalizedValue.includes('–æ–±—Ä–∞—â–µ–Ω–∏—è')) {
                    imageSrc = this.images['–ó–Ω–∞–∫ –æ–±—Ä–∞—â–µ–Ω–∏—è'];
                }
                
                if (imageSrc) {
                    preview.src = imageSrc;
                    preview.style.display = 'block';
                }
            }

            clearAllValidationErrors() {
                const fields = [
                    'proizvoditelnostFact', 
                    'proverkaMarkirovki', 
                    'nomerOtrezka', 
                    'kolichestvoGP', 
                    'vesGP', 
                    'vvodRegranulata',
                    'obrazcyKolichestvo',
                    'obrazcyMetrazh'
                ];
                
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('validation-error');
                        el.classList.remove('validation-success');
                    }
                    const err = document.getElementById(id + 'Error');
                    if (err) err.style.display = 'none';
                });
                
                // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ –≤ —Å—Ç—Ä–æ–∫–∞—Ö –æ—Ç—Ö–æ–¥–æ–≤
                const wasteInputs = document.querySelectorAll('.vesOthodovInline');
                wasteInputs.forEach(input => {
                    input.classList.remove('validation-error');
                    input.classList.remove('validation-success');
                });
                
                const wasteSelects = document.querySelectorAll('.vidyOthodovSelect, .prichinaOthodovSelect');
                wasteSelects.forEach(select => {
                    select.classList.remove('validation-error');
                });
                
                document.getElementById('wasteError').style.display = 'none';
                
                // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                const productivityError = document.getElementById('productivityDeviationError');
                if (productivityError) {
                    productivityError.style.display = 'none';
                }
            }

            showEmployeeSelect() { document.getElementById('employeeGroup').style.display = 'block'; }
            hideEmployeeSelect() { document.getElementById('employeeGroup').style.display = 'none'; }
            showEmployeeData() { document.getElementById('employeeData').style.display = 'block'; }
            hideEmployeeData() {
                document.getElementById('employeeData').style.display = 'none';
                const fields = [
                    'fioView', 'fio2View', 'smenaView','denbView','proizView','centerView','commentView',
                    'nomenklaturaView','partiyaView','vesPogMetraView','ostatokView','harakteristikiView',
                    'markaPEView','proizvoditelnostView','markirovkaView','znakImageView',
                    'obrazcyShtView','obrazcyMetrView','markaRegranulataView',
                    'kolvoRegranulataView','normaVremeniView'
                ];
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                document.getElementById('znakImagePreview').style.display = 'none';
            }
            showEmployeeInput() { document.getElementById('employeeInput').style.display = 'block'; }
            hideEmployeeInput() { document.getElementById('employeeInput').style.display = 'none'; }

            populateMainDowntimeSelect() {
                const select = document.querySelector('#downtime-container .prichinaProstoya');
                if (select) {
                    this.populateDowntimeSelect(select);
                }
            }

            populateDowntimeSelect(selectElement) {
                if (!selectElement) return;
                
                const currentValue = selectElement.value;
                
                selectElement.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>';
                this.downtimeReasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason;
                    option.textContent = reason;
                    selectElement.appendChild(option);
                });
                
                if (currentValue && this.downtimeReasons.includes(currentValue)) {
                    selectElement.value = currentValue;
                }
            }

            populateWasteSelect(selectElement) {
                if (!selectElement) return;
                
                const currentValue = selectElement.value;
                
                selectElement.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>';
                this.wasteReasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason;
                    option.textContent = reason;
                    selectElement.appendChild(option);
                });
                
                if (currentValue && this.wasteReasons.includes(currentValue)) {
                    selectElement.value = currentValue;
                }
            }

            async handleSubmit() {
                if (!this.validateAllFields()) {
                    this.showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    return;
                }

                if (!this.currentEmployee) {
                    this.showMessage('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 'error');
                    return;
                }

                const recordId = this.currentEmployee.id || this.currentEmployee['id'] || null;
                const date = document.getElementById('dateSelect').value;

                if (!recordId) {
                    this.showMessage('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ (id)', 'error');
                    return;
                }

                const downtimeData = this.getFormattedDowntime();
                const wasteData = this.getFormattedWasteData();
                const obrazcyData = this.getFormattedObrazcy();

                const submitData = {
                    recordId: recordId,
                    date: date,
                    proizvoditelnostFact: document.getElementById('proizvoditelnostFact').value || null,
                    proverkaMarkirovki: document.getElementById('proverkaMarkirovki').value || null,
                    nomerOtrezka: document.getElementById('nomerOtrezka').value || null,
                    kolichestvoGP: document.getElementById('kolichestvoGP').value || null,
                    vesGP: document.getElementById('vesGP').value || null,
                    vvodRegranulata: document.getElementById('vvodRegranulata').value || null,
                    vesOthodov: wasteData.wasteWeights,
                    –û–±—Ä–∞–∑—Ü—ã_–Ω–æ–≤—ã–µ: obrazcyData,
                    vidyOthodov: wasteData.wasteTypes,
                    prichinaOthodov: wasteData.wasteReasons,
                    prichinaProstoya: downtimeData.reasons,
                    vremyaProstoya: downtimeData.times,
                    "–û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è": downtimeData.totalTimeFormatted
                };

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                try {
                    const response = await fetch(this.saveWebhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(submitData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const result = await response.json().catch(() => ({}));

                    if (result && result.success === false) {
                        this.showMessage('–°–µ—Ä–≤–µ—Ä –æ—Ç–∫–∞–∑–∞–ª –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                    } else {
                        this.showMessage('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');

                        const idx = this.allData.findIndex(r => (r.id && String(r.id) === String(recordId)) || (r.index !== undefined && r.index === this.currentEmployee.index));
                        if (idx !== -1) {
                            this.allData[idx]["–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç"] = submitData.proizvoditelnostFact;
                            this.allData[idx]["–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏"] = submitData.proverkaMarkirovki;
                            this.allData[idx]["–ù–æ–º–µ—Ä –æ—Ç—Ä–µ–∑–∫–∞/–±—É—Ö—Ç—ã"] = submitData.nomerOtrezka;
                            this.allData[idx]["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω–æ–π –ì–ü"] = submitData.kolichestvoGP;
                            this.allData[idx]["–í–µ—Å –ì–ü"] = submitData.vesGP;
                            this.allData[idx]["–í–≤–æ–¥ —Ä–µ–≥—Ä–∞–Ω—É–ª—è—Ç–∞ –ö–ì."] = submitData.vvodRegranulata;
                            this.allData[idx]["–í–µ—Å –æ—Ç—Ö–æ–¥–æ–≤"] = submitData.vesOthodov;
                            this.allData[idx]["–û–±—Ä–∞–∑—Ü—ã_–Ω–æ–≤—ã–µ"] = submitData.–û–±—Ä–∞–∑—Ü—ã_–Ω–æ–≤—ã–µ;
                            this.allData[idx]["–í–∏–¥—ã –æ—Ç—Ö–æ–¥–æ–≤"] = submitData.vidyOthodov;
                            this.allData[idx]["–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Ö–æ–¥–æ–≤"] = submitData.prichinaOthodov;
                            this.allData[idx]["–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–æ—è"] = submitData.prichinaProstoya;
                            this.allData[idx]["–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è"] = submitData.vremyaProstoya;
                            this.allData[idx]["–û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è"] = submitData["–û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è"];
                        }
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
                    this.showMessage('–î–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –í–ò–ö
        function vikCancelSubmission() {
            const modal = document.getElementById('deviationModal');
            if (modal) modal.style.display = 'none';
            
            // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
            if (window._combinedForm && window._combinedForm.pendingTimeSlot) {
                const pendingTimeSlot = window._combinedForm.pendingTimeSlot;
                const suffix = pendingTimeSlot === '8:00' ? '1' : pendingTimeSlot === '12:00' ? '2' : '3';
                const submitBtn = document.getElementById(`vikSubmitBtn${suffix}`);
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            }
            
            // –û—á–∏—â–∞–µ–º pending –¥–∞–Ω–Ω—ã–µ
            if (window._combinedForm) {
                window._combinedForm.pendingTimeSlot = null;
                window._combinedForm.pendingDeviations = [];
                window._combinedForm.pendingMeasurementData = null;
                window._combinedForm.vikClearDeviationHighlights();
                window._combinedForm.vikShowInfo('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞.');
            }
        }

        function vikConfirmSubmission() {
            const modal = document.getElementById('deviationModal');
            if (modal) modal.style.display = 'none';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç —Ñ–æ—Ä–º—ã
            if (window._combinedForm && window._combinedForm.pendingTimeSlot && window._combinedForm.pendingMeasurementData) {
                window._combinedForm.vikSendMeasurementsData(window._combinedForm.pendingTimeSlot);
            }
            
            // –û—á–∏—â–∞–µ–º pending –¥–∞–Ω–Ω—ã–µ
            if (window._combinedForm) {
                window._combinedForm.pendingTimeSlot = null;
                window._combinedForm.pendingDeviations = [];
                window._combinedForm.pendingMeasurementData = null;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            const combinedForm = new CombinedForm();
            window._combinedForm = combinedForm;
        });
    </script>
</body>
</html>
